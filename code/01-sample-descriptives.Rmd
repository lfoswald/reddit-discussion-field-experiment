---
title: "Sample & Descriptives"
subtitle: "Reddit Communities Field Experiment"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, out.width = "100%", out.height = "30%", message=F, warning=F)
```

```{r}
library(tidyverse)
library(readr)
library(gridExtra)
library(haven)
library(RColorBrewer)
library(igraph)
library(kableExtra)
library(ggridges)
library(lubridate)
```

Load anonymous data (no comment texts, open comments, usernames or email addresses)
```{r , results='hide'}
# reddit data
discussion_data <- read_csv("../data/anon/discussions_anon.csv")
external_data <- read_csv("../data/anon/external_reddit_anon.csv")
user_data <-  read_csv("../data/anon/users_anon.csv")

# survey data
pre_survey <- read_csv("../data/anon/pre_survey_anon.csv")
post_surveys <- read_csv("../data/anon/post_surveys_anon.csv")
```


#WS set useful values

```{r}
colors <- c(control = "gray", incentives = "#29c195", moderation = "#6699FF")

#adjust alphas to .7
colors <- c(control = adjustcolor("gray", alpha.f = .7), incentives = adjustcolor("#29c195", alpha.f = .7), moderation = adjustcolor("#6699FF", alpha.f = .7))
```


#WS Explore Raw data

```{r}
user_data
```


```{r}
discussion_data
```


```{r}
external_data
```


```{r}
pre_survey
post_surveys

```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```



Combine survey and reddit data
```{r}
## Reddit metrics by user - add to sample

user_comments <- discussion_data%>%
  group_by(ParticipantID)%>%
  mutate(comment_count = n(),
         comment_mean_score = round(mean(score_comment,na.rm=T),3),
         comment_mean_tox = round(mean(comment_toxicity,na.rm=T),3),
         comment_mean_lenght = round(mean(length_comment_char,na.rm=T),3))%>%
  slice(1)%>%
  select(ParticipantID,comment_count,comment_mean_lenght,comment_mean_score,comment_mean_tox)

user_comments_external <- external_data%>%
  group_by(ParticipantID)%>%
  mutate(ex_comment_count = n(),
         ex_comment_mean_score = round(mean(score_comment,na.rm=T),3),
         ex_comment_mean_tox = round(mean(comment_toxicity,na.rm=T),3),
         ex_comment_mean_lenght = round(mean(length_comment_char,na.rm=T),3))%>%
  slice(1)%>%
  select(ParticipantID,ex_comment_count,ex_comment_mean_score,ex_comment_mean_tox,ex_comment_mean_lenght)

sample <- pre_survey%>%
  filter(on_reddit == 1)%>%
  left_join(., user_data, by = "ParticipantID")%>%
  left_join(., user_comments, by = "ParticipantID")%>%
  left_join(., user_comments_external, by = "ParticipantID")

write_csv(sample, file = "../data/anon/sample_anon.csv")   
```

## Comment activity per user
```{r, fig.width=12, fig.height=5}
# comments per user
part1 <- sample%>%
  mutate(comment_count = ifelse(is.na(comment_count),0,comment_count))%>%
  ggplot()+
  geom_bar(aes(comment_count), fill = "#6699FF")+
  theme_bw()+
  ylab("Number of users")+
  xlab("Number of comments per user")+
  labs(title = "Comment activity", subtitle = paste0("20 discussion issues | N(comments) = ", 
                                                     nrow(discussion_data), " | N(users) = ", nrow(sample)))+
  annotate(geom = "text", x = 20, hjust = 0,  y = 200, label = paste0("min = ",min(sample$comment_count,na.rm=T)))+
  annotate(geom = "text", x = 20, hjust = 0, y = 180, label = paste0("max = ",max(sample$comment_count,na.rm=T)))

any_check <- post_surveys%>%
  group_by(ParticipantID)%>%
  mutate(any_checkin = 1)%>%
  slice(1)%>%
  pull(ParticipantID)

sample%>% mutate(active = ifelse(is.na(comment_count),"no","yes"),
         active = ifelse(!ParticipantID %in% any_check & active == "no", "inactive", active))%>%count(active)

bars <- sample%>%
  mutate(active = ifelse(is.na(comment_count),"no","yes"),
         active = ifelse(!ParticipantID %in% any_check & active == "no", "inactive", active))%>%
  ggplot()+
  geom_bar(aes(factor(active)), fill = c("darkgrey","lightgrey","#6699FF"))+
  xlab("Wrote any comment")+
  ylab("")+
  annotate(geom = "text", x = "inactive",   y = 87, label = "97")+
  annotate(geom = "text", x = "no",   y = 82, label = "92")+
  annotate(geom = "text", x = "yes",   y = 321, label = "331")+
  theme_bw()
  
histog <- ggplot(sample)+
  geom_bar(aes(comment_count), fill = "#6699FF")+
  xlab("Comments written in experiment")+
  ylab("Number of users")+
  theme_bw()

dots <- ggplot(sample)+
  geom_point(aes(comment_count, log(comment_karma+1), colour = comment_mean_tox, 
                 size = comment_mean_lenght), alpha = 0.8)+
  #geom_smooth(method="lm", aes(comment_count,comment_mean_tox))+
  scale_colour_gradient(low = "#6699FF", high = "black")+
  xlab("Comments written in experiment")+
  ylab("Comment karma on Reddit (log-scale)")+
  theme_bw()+
  guides(colour = guide_legend(title="Toxicity"), size = guide_legend(title="Length"))

combi2 <- grid.arrange(bars, histog, widths = c(3,4.5), top = "User level discussion participation")

ggsave("../output/participation_dots.pdf", dots, width = 5, height = 4)
ggsave("../output/participation_total2.pdf", combi2, width = 6, height = 3)
```


# Survey Sample 

## Demographics 
```{r, fig.width=12, fig.height=4}
#(1 = Man, 2 = Woman, 3 = Other)
table(sample$gender)

table(sample$condition)
table(sample$subreddit)

ageplot <- ggplot(sample)+
  geom_histogram(aes(age), fill = "#6699FF")+
  theme_bw()+ 
  ylab("Sample: Participants who joined subreddit")+
  xlab(paste0("Age in years (M = ",round(mean(sample$age),2),", SD = ",round(sd(sample$age),2),")"))+
  annotate(geom="text", x=60, y=30,hjust = 0, label= paste("Male: ",table(sample$gender)[1]))+
  annotate(geom="text", x=60, y=28,hjust = 0, label= paste("Female: ",table(sample$gender)[2]))+
  annotate(geom="text", x=60, y=26,hjust = 0, label= paste("Other: ",table(sample$gender)[3]))+
  annotate(geom="text", x=60, y=33,hjust = 0, label= paste("N: ", nrow(sample)),fontface =2)

educplot <- ggplot(sample)+
  geom_bar(aes(education), fill = "#6699FF")+
  coord_flip()+
  ylab("")+
  xlab("Level of formal education")+
  theme_bw()+
  annotate(geom="text", x = 1, y = 0, hjust = 0,  label = "No degree")+
  annotate(geom="text", x = 2, y = 0, hjust = 0, label = "High school")+
  annotate(geom="text", x = 3, y = 0, hjust = 0, label = "Some college education, no degree")+
  annotate(geom="text", x = 4, y = 0, hjust = 0, label = "Bachelor's degree")+
  annotate(geom="text", x = 5, y = 0, hjust = 0, label = "Some postgraduate education, no degree")+
  annotate(geom="text", x = 6, y = 0, hjust = 0, label = "Postgraduate degree")

demo <- grid.arrange(ageplot, educplot, nrow = 1,
                     top = "Age and education across study sample")

ggsave("../output/demographics.pdf",demo, width = 10, height = 5)
```
## Political variables pre-survey 
```{r, fig.width=12, fig.height=4}
int <- ggplot(sample, aes(polinterest))+
  geom_bar(fill = "#6699FF")+
  ggtitle("Political Interest")+
  xlab("")+
  ylab("")+
  theme_bw()+
  xlim("Not interested", "Sighly interested","Moderately interested", "Very interested")

pol <- ggplot(sample)+
  geom_bar(aes(x = leftright, fill = ..x..))+
  theme_bw()+
  scale_fill_gradient2(low='#6699ff', mid='lightgrey', high='#bc3455', midpoint=6)+
  ggtitle("Political Orientation")+
  xlab("")+
  ylab("")+
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  xlim("far left", "", "", "", "", "", "", "",
       "", "", "far right")

polint <- grid.arrange(int, pol, nrow = 1)

ggsave("../output/pol_lefright.pdf", polint, width = 12 , height = 5) 
ggsave("../output/lefright.pdf", pol, width = 4 , height = 4)
```

# Reddit Data

## Engagement metrics by political issue 
```{r, echo = F}
discussion_data%>%
  mutate(Issue = post_title)%>%
  group_by(Issue)%>%
  summarise(Toxicity = round(mean(comment_toxicity, na.rm = T),3),
          Comments = n(),
          Views = sum(unique(total_views), na.rm = T))%>%
  group_by(Issue)%>%
  slice(1)%>%
  arrange(desc(Toxicity))%>%
  kbl(format = "html", booktabs = TRUE)

# note: one climate change post had NA views
```
## Toxicity distributions by political issue
```{r, fig.height=6, fig.width=12}
issue_order <- discussion_data%>%
  group_by(post_title)%>%
  summarise(Toxicity = round(mean(comment_toxicity, na.rm = T),3))%>%
  arrange(desc(Toxicity))%>%
  pull(post_title)

discussion_data$issues <- factor(discussion_data$post_title, levels = issue_order)

colour_values <- c("#6699ff", "#729dee", "#7ca1dd", "#86a5cc", "#91a9bb", "#9bada9", "#a6b298", "#d3d3d3", "#bfc7c7", "#b5b1b1", "#ab9b9b", "#a18585", "#976f6f", "#8d5959", "#844444", "#7b3232", "#732525", "#6a1a1a", "#621010", "#bc3455")

issues <- c("US foreign policy toward Israel and Gaza","Legality of prostitution", "Use of gender-neutral language and pronouns", "Death penalty reestablishment in the US", "US financial and military aid to Ukraine", "Gun control laws", "Impact of social media on democracy", "Immigration regulation", "Ban on fur clothing","Police accountability and body cameras", "Climate change and environmental threats","Mandatory vaccination policies by employers", "Universal healthcare responsibility","Government forgiveness of student loan debt", "Artificial intelligence replacing human labor", "Vegetarian food policies in public cantines", "Economic impact of universal basic income",  "Federal minimum wage increase", "Government investment in renewable energy", "Regulation of Airbnb in cities")

# colours, means
tox_ridge <- ggplot(discussion_data)+
  geom_density_ridges(aes(x = comment_toxicity, y = fct_rev(issues), fill = fct_rev(issues), 
                          alpha = 0.5))+
  theme(legend.position = "bottom", legend.direction="vertical", 
        legend.title = element_blank())+
  guides(alpha = "none")+
  ylab("")+
  xlab("")+
  scale_y_discrete(labels = rev(issues))+
  theme_ridges() + 
  scale_fill_manual(values = colour_values) +
  scale_x_continuous(limits = c(0, 0.6))+
  theme(legend.position = "none")
tox_ridge

ggsave("../output/toxicity_issues_ridges.pdf", tox_ridge, width = 10, height = 6)
```
## Reddit mertrics over time

```{r, fig.height=4, fig.width=12}
views <- discussion_data%>%
  group_by(subreddit,date(created_post))%>%
  slice(1)%>%
  ggplot(aes(x = date(created_post), y = total_views, color = subreddit))+
  geom_smooth(method = loess,alpha=0.1)+
  geom_point(alpha = 0.3)+
  theme_bw()+
  scale_color_manual(values = c("#29c195","#6699ff","#424656","#a7aabd","#f96d86","#bc3455"))+
  ylab("")+
  guides(color = "none")+
  ggtitle("Views per post")+
  xlab("Date")

comments <- discussion_data%>%
  group_by(subreddit,date(created_post))%>%
  slice(1)%>%
  ggplot(aes(x = date(created_post), y = `Collected comments`, color = subreddit))+
  geom_smooth(method = loess,alpha=0.1)+
  geom_point(alpha = 0.3)+
  theme_bw()+
  scale_color_manual(values = c("#29c195","#6699ff","#424656","#a7aabd","#f96d86","#bc3455"))+
  ylab("")+
  guides(color = "none")+
  ggtitle("Comments per post")+
  xlab("Date")

comments_views <- discussion_data%>%
  mutate(comments_per_views = `Collected comments`/total_views)%>%
  group_by(subreddit,date(created_post))%>%
  slice(1)%>%
  ggplot(aes(x = date(created_post), y = comments_per_views, color = subreddit))+
  geom_smooth(method = loess,alpha=0.1)+
  geom_point(alpha = 0.3)+
  theme_bw()+
  scale_color_manual(values = c("#29c195","#6699ff","#424656","#a7aabd","#f96d86","#bc3455"))+
  ylab("")+
  ggtitle("Comments/views ratio")+
  xlab("Date")

activity_combi <- grid.arrange(views, comments, comments_views, nrow=1, widths = c(3,3,4))

ggsave("../output/comments_views.pdf", activity_combi, width = 14, height = 5)

```
```{r, fig.height=4, fig.width=12}
toxicity <- ggplot(discussion_data, aes(x = date(created_post), y = comment_toxicity, color = subreddit))+
  geom_smooth(method = loess,alpha=0.1)+
  geom_point(alpha = 0.1)+
  theme_bw()+
  scale_color_manual(values = c("#29c195","#6699ff","#424656","#a7aabd","#f96d86","#bc3455"))+
  ylab("")+
  guides(color = "none")+
  ggtitle("Comment toxicity")+
  xlab("Date")

length <- ggplot(discussion_data, aes(x = date(created_post), y = length_comment_char, color = subreddit))+
  geom_smooth(method = loess,alpha=0.1)+
  geom_point(alpha = 0.1)+
  theme_bw()+
  scale_color_manual(values = c("#29c195","#6699ff","#424656","#a7aabd","#f96d86","#bc3455"))+
  ylab("")+
  guides(color = "none")+
  ggtitle("Comment length")+
  xlab("Date")

score <- discussion_data%>%
  group_by(subreddit,date(created_post))%>%
  mutate(score_views = score_post/total_views)%>%
  slice(1)%>%
  ggplot(aes(x = date(created_post), y = score_views, color = subreddit))+
  geom_smooth(method = loess,alpha=0.1)+
  geom_point(alpha = 0.3)+
  theme_bw()+
  scale_color_manual(values = c("#29c195","#6699ff","#424656","#a7aabd","#f96d86","#bc3455"))+
  ylab("")+
  ggtitle("Post score/views ratio")+
  xlab("Date")

characteristics_combi <- grid.arrange(toxicity, length, score, nrow=1, widths = c(3,3,4))

ggsave("../output/characteristics_combi.pdf", characteristics_combi, width = 14, height = 5)

```

### Reddit activity by users - internal vs. external
```{r, fig.width=12, fig.height=5}
comments_tox <- ggplot(sample,aes(x = comment_mean_tox, y = ex_comment_mean_tox, size = comment_count))+
  geom_point(alpha = 0.5, color = "#6699FF")+
  theme_bw()+
  xlab("Average comment toxicity in experiment")+
  ylab("Average external comment toxicity")+
  guides(color = "none", size = "none")+
  geom_abline()

cor.test(sample$comment_mean_tox,sample$ex_comment_mean_tox)

comments_length <- ggplot(sample,aes(x = comment_mean_lenght, y = ex_comment_mean_lenght,
                                     size = comment_count))+
  geom_point(alpha = 0.5, color = "#6699FF")+
  theme_bw()+
  xlab("Average comment length in experiment")+
  ylab("Average external comment length")+
  guides(color = "none", size = "none")+
  geom_abline()

cor.test(sample$comment_mean_lenght,sample$ex_comment_mean_lenght)

cor.test(log(sample$comment_karma),sample$comment_count)

comment_tox_length <- grid.arrange(comments_tox, comments_length, nrow = 1, top = "Comment characteristics per active user")
ggsave("../output/comment_tox_length.pdf", comment_tox_length, width = 7 , height = 3.5)
```

## Comment karma and platform seniority
```{r, fig.width=12, fig.height=5}
# Posting a comment on an existing post and receiving upvotes results in "comment" karma
k1 <- ggplot(sample)+
  geom_histogram(aes(comment_karma), fill = "#6699FF")+
  theme_bw()+
  ylab("Number of users")+
  xlab("Comment Karma")

k2 <- ggplot(sample)+
  geom_histogram(aes(log(comment_karma)), fill = "#6699FF")+
  theme_bw()+
  ylab("Number of users")+
  xlab("Comment Karma (Log-scale)")

create <- ggplot(sample)+
  geom_histogram(aes(date(created)), fill = "lightgrey", bins = 100)+
  annotate("text", x = min(date(sample$created), na.rm = TRUE), y = Inf, label = paste("First:", min(date(sample$created), na.rm = T)), vjust = 2, hjust = 0) +
  annotate("text", x = max(date(sample$created), na.rm = TRUE), y = Inf, label = paste("Last:", max(date(sample$created), na.rm = T)), vjust = 2, hjust = 1)+
  theme_bw()+
  ylab("Number of accounts")+
  xlab("Date joined Reddit")

kplot <- grid.arrange(k2,create, nrow = 1,
                      top = paste0("Distributions of platform seniority (N = ",nrow(sample),") Start of recruitment: 2024-05-09"))

ggsave("../output/platform_seniority.pdf", kplot, width = 8, height = 4)
```

## External comments
```{r, fig.width=12, fig.height=5}
internal_comments <- discussion_data %>% mutate(source = "internal")%>%
  select(ParticipantID,created_comment,comment_toxicity,length_comment_char, source)%>%
  filter(created_comment > as_datetime("2024-06-10") & created_comment < as_datetime("2024-07-06"))
  
external_comments <- external_data %>% mutate(source = "external")%>%
  select(ParticipantID,created_comment,comment_toxicity,length_comment_char, source)%>%
  filter(created_comment > as_datetime("2024-05-13"))

all_data <- bind_rows(internal_comments, external_comments)
all_data$created_comment <- as.Date(all_data$created_comment)

all_data <- all_data %>%
  mutate(week = floor_date(created_comment, unit = "week"))

daily_summary <- all_data %>%
  group_by(source, ParticipantID, created_comment) %>%
  dplyr::summarize(comment_volume = n(),  # Count of comments per user per day
    avg_toxicity = mean(comment_toxicity, na.rm = TRUE)) %>%
  ungroup()

study_start <- as.Date("2024-06-10")
study_end <- as.Date("2024-07-05")

int_ext <- ggplot(daily_summary, aes(x = created_comment, y = avg_toxicity)) +
  geom_point(data = subset(daily_summary, source == "external"),
             aes(size = comment_volume), color = "grey", alpha = 0.2) +
  geom_point(data = subset(daily_summary, source == "internal"),
             aes(size = comment_volume), color = "#6699FF", alpha = 0.5) +
  geom_smooth(data = subset(daily_summary, source == "external"),
              aes(y = avg_toxicity), color = "darkgrey", method = "loess", se = FALSE) +
  geom_smooth(data = subset(daily_summary, source == "internal"),
              aes(y = avg_toxicity), color = "#3d5b99", method = "loess", se = FALSE) +
  geom_vline(xintercept = as.numeric(study_start), linetype = "dashed", color = "black") +
  geom_vline(xintercept = as.numeric(study_end), linetype = "dashed", color = "black") +
  labs(x = "Date", y = "Average toxicity (per user per day)",
       size = "Number of Comments \n per user per day",
       title = "Daily Comment Toxicity and Volume per User (External vs Internal Data)") +
  scale_size_continuous(range = c(1, 5)) +  
  theme_minimal() +
  theme(legend.position = "right",
    plot.title = element_text(hjust = 0.5))
int_ext

ggsave("../output/internal_external_toxicity.pdf", int_ext, width = 8, height = 3)
```




```{r, fig.width=12, fig.height=5}
# Aggregate data by ParticipantID, day, and source

daily_summary_act <- all_data %>%
  group_by(source, ParticipantID, created_comment) %>%
  dplyr::summarize(comment_volume = n(), 
    avg_toxicity = mean(comment_toxicity, na.rm = TRUE)) %>%
  ungroup()

int_ext_act <- ggplot(daily_summary, aes(x = created_comment, y = comment_volume)) +
  geom_point(data = subset(daily_summary, source == "external"),
             aes(size = avg_toxicity, alpha = avg_toxicity), color = "grey") +
  geom_point(data = subset(daily_summary, source == "internal"),
             aes(size = avg_toxicity, alpha = avg_toxicity), color = "#6699FF") +
  geom_smooth(data = subset(daily_summary, source == "external"),
              aes(y = comment_volume), color = "darkgrey", method = "loess", se = FALSE) +
  geom_smooth(data = subset(daily_summary, source == "internal"),
              aes(y = comment_volume), color = "#3d5b99", method = "loess", se = FALSE) +
  geom_vline(xintercept = as.numeric(study_start), linetype = "dashed", color = "black") +
  geom_vline(xintercept = as.numeric(study_end), linetype = "dashed", color = "black") +
  labs(x = "Date", y = "Number of Comments per User per Day",
       size = "Average Toxicity",
       alpha = "Average Toxicity",
       title = "Daily Comment Volume and Toxicity per User (External vs Internal Data)") +
  scale_size_continuous(range = c(1, 5)) + 
  scale_alpha_continuous(range = c(0.2, 1)) + 
  theme_minimal() +
  theme(legend.position = "right",
    plot.title = element_text(hjust = 0.5))

int_ext_act

ggsave("../output/internal_external_activity.pdf", int_ext_act, width = 9, height = 3)
```



# WS: relative change in commenting activity


```{r}
#all_data %>% pull(source) %>%

```


```{r}
daily_summary_act <- all_data %>%
  group_by(source, ParticipantID, created_comment) %>%
  dplyr::summarize(comment_volume = n(), 
    avg_toxicity = mean(comment_toxicity, na.rm = TRUE)) %>%
  ungroup()


comment_data_ranges <- daily_summary_act %>% group_by(ParticipantID) %>% dplyr::summarize(earliest_comment = min(created_comment), latest_comment = max(created_comment))

#plot hist of earliest and latest comment dates
hist(comment_data_ranges$earliest_comment, breaks = 20, main = "Earliest comment date", xlab = "Date")
hist(comment_data_ranges$latest_comment, breaks = 20, main = "Latest comment date", xlab = "Date")

min(comment_data_ranges$earliest_comment)
max(comment_data_ranges$latest_comment)

study_start
as.numeric(study_start)

#calculate number of days between earliest comment and study start
days_prestudy_period <- study_start - min(comment_data_ranges$earliest_comment)

#calculate mean number of comments per day in the pre-study period
mean_prestudy_daily_comments <- daily_summary_act %>%
  filter(created_comment < study_start) %>%
  group_by(ParticipantID) %>%
  dplyr::summarize(mean_daily_comments_prestudy = sum(comment_volume)/as.numeric(days_prestudy_period))

mean_prestudy_daily_comments

#calculate mean number of comments-per day in the study period, within study
mean_duringstudy_int_daily_comments <- daily_summary_act %>% filter(source == "internal") %>%
  filter(created_comment >= study_start & created_comment <= study_end) %>%
  group_by(ParticipantID) %>%
  dplyr::summarize(mean_daily_comments_instudy = sum(comment_volume)/as.numeric(study_end - study_start))

#calculate mean number of comments-per day in the study period, outside study
mean_duringstudy_ext_daily_comments <- daily_summary_act %>% filter(source == "external") %>%
  filter(created_comment >= study_start & created_comment <= study_end) %>%
  group_by(ParticipantID) %>%
  dplyr::summarize(mean_daily_comments_extstudy = sum(comment_volume)/as.numeric(study_end - study_start))

#join the two dataframes
mean_daily_comments <- left_join(mean_prestudy_daily_comments, mean_duringstudy_int_daily_comments, by = "ParticipantID")
mean_daily_comments <- left_join(mean_daily_comments, mean_duringstudy_ext_daily_comments, by = "ParticipantID")
```


```{r}
#to do: add calculation of prob(comment_at_all) per day
#daily_summary_act %>% pull(created_comment) %>% unique %>% hist(breaks = "day")
#daily_summary_act %>% pull(created_comment) %>% hist(breaks = "day") #star

daily_summary_act_complete <- daily_summary_act %>%
  complete(source, ParticipantID, created_comment = seq.Date(min(created_comment), max(created_comment), by = "day"), fill = list(comment_volume = 0, avg_toxicity = NA))

daily_summary_act_complete

mean_duringstudy_int_commentprob <- daily_summary_act_complete %>% filter(source == "internal") %>%
  filter(created_comment >= study_start & created_comment <= study_end) %>%
  group_by(ParticipantID) %>%
  dplyr::summarize(duringstudy_int_daily_commentprob = sum(comment_volume!=0)/as.numeric(study_end - study_start))

mean_duringstudy_int_commentprob

mean_duringstudy_ext_commentprob <- daily_summary_act_complete %>% filter(source == "external") %>%
  filter(created_comment >= study_start & created_comment <= study_end) %>%
  group_by(ParticipantID) %>%
  dplyr::summarize(duringstudy_ext_daily_commentprob = sum(comment_volume!=0)/as.numeric(study_end - study_start))

mean_prestudy_commentprob <- daily_summary_act_complete %>%
  filter(created_comment < study_start) %>%
  group_by(ParticipantID) %>%
  dplyr::summarize(prestudy_daily_commentprob = sum(comment_volume!=0)/as.numeric(days_prestudy_period))

mean_daily_comments <- left_join(mean_daily_comments, mean_duringstudy_int_commentprob, by = "ParticipantID")
mean_daily_comments <- left_join(mean_daily_comments, mean_duringstudy_ext_commentprob, by = "ParticipantID")
mean_daily_comments <- left_join(mean_daily_comments, mean_prestudy_commentprob, by = "ParticipantID")
```



```{r}
#plot the two variables in a square plot
par(pty="s")
plot(mean_daily_comments$mean_daily_comments_prestudy, mean_daily_comments$mean_daily_comments_instudy, xlab = "Mean daily comments pre-study", ylab = "Mean daily comments in study", main = "Mean daily comments pre-study vs in study")
```


```{r}
# join mean_daily_comments to sample
s <- left_join(sample, mean_daily_comments, by = "ParticipantID")

s
```



```{r}
#come back and use S for this
daily_summary_act %>% pull(created_comment) %>% hist(breaks = "day") #star

# bar chart of comment count by day, stacked by source=="internal" vs source=="external"
barplot(table(daily_summary_act$source, daily_summary_act$created_comment), beside = T, col = c("grey50", "blue"), legend = T, border = NA)

```


```{r}
# break down by condition
control <- s %>% filter(condition == "control")
moderation <- s %>% filter(condition == "moderation")
incentives <- s %>% filter(condition == "incentives")



#plot the two variables in a square plot
par(pty="s", cex = .4)
plot(control$mean_daily_comments_prestudy, control$mean_daily_comments_instudy, xlab = "Mean daily comments pre-study", ylab = "Mean daily comments in study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['control'], xlim = c(0,13), ylim = c(0,5))
points(moderation$mean_daily_comments_prestudy, moderation$mean_daily_comments_instudy, pch = 16, col = colors['moderation'])
points(incentives$mean_daily_comments_prestudy, incentives$mean_daily_comments_instudy, pch = 16, col = colors['incentives'])
legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 16, bty = "n")
#draw a diagonal line
abline(0,1)

# # zoom in to the 0,4 interval
# plot(control$mean_daily_comments_prestudy, control$mean_daily_comments_instudy, xlab = "Mean daily comments pre-study", ylab = "Mean daily comments in study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['control'], xlim = c(0,4), ylim = c(0,4))
# points(moderation$mean_daily_comments_prestudy, moderation$mean_daily_comments_instudy, pch = 16, col = colors['moderation'])
# points(incentives$mean_daily_comments_prestudy, incentives$mean_daily_comments_instudy, pch = 16, col = colors['incentives'])
# legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 16, bty = "n")
# abline(0,1)
# 
# # zoom in to the 0,2 interval
# plot(control$mean_daily_comments_prestudy, control$mean_daily_comments_instudy, xlab = "Mean daily comments pre-study", ylab = "Mean daily comments in study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['control'], xlim = c(0,2), ylim = c(0,2))
# points(moderation$mean_daily_comments_prestudy, moderation$mean_daily_comments_instudy, pch = 16, col = colors['moderation'])
# points(incentives$mean_daily_comments_prestudy, incentives$mean_daily_comments_instudy, pch = 16, col = colors['incentives'])
# legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 16, bty = "n")
# abline(0,1)
```


```{r}
# a version with both axes logged
# par(pty="s", cex = .7)
# plot(log(control$mean_daily_comments_prestudy), log(control$mean_daily_comments_instudy), xlab = "Logged Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Logged mean daily comments pre-study vs in study", pch = 16, col = colors['control'])
# points(log(moderation$mean_daily_comments_prestudy), log(moderation$mean_daily_comments_instudy), pch = 16, col = colors['moderation'])
# points(log(incentives$mean_daily_comments_prestudy), log(incentives$mean_daily_comments_instudy), pch = 16, col = colors['incentives'])
# legend("bottomright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 16)
# abline(0,1)
# 
# #jittered version
# par(pty="s", cex = .7)
# plot(jitter(log(control$mean_daily_comments_prestudy), amount = 0.1), jitter(log(control$mean_daily_comments_instudy), amount = 0.1), xlab = "Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Control", pch = 16, col = colors['control'])
# points(jitter(log(moderation$mean_daily_comments_prestudy), amount = 0.1), jitter(log(moderation$mean_daily_comments_instudy), amount = 0.1), pch = 16, col = colors['moderation'])
# points(jitter(log(incentives$mean_daily_comments_prestudy), amount = 0.1), jitter(log(incentives$mean_daily_comments_instudy), amount = 0.1), pch = 16, col = colors['incentives'])
# legend("bottomright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 16)
# abline(0,1)


# # 3-gang version subset by condition
# par(pty="s", mfrow = c(1,3), cex = .6)
# plot(log(control$mean_daily_comments_prestudy), log(control$mean_daily_comments_instudy), xlab = "Logged Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Control", pch = 16, col = colors['control'])
# abline(0,1)
# plot(log(moderation$mean_daily_comments_prestudy), log(moderation$mean_daily_comments_instudy), xlab = "Logged Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Moderation", pch = 16, col = colors['moderation'])
# abline(0,1)
# plot(log(incentives$mean_daily_comments_prestudy), log(incentives$mean_daily_comments_instudy), xlab = "Logged Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Incentives", pch = 16, col = colors['incentives'])
# abline(0,1)


# 
# 
# # jittered 3-gang
# par(pty="s", mfrow = c(1,3), cex = .6)
# plot(jitter(log(control$mean_daily_comments_prestudy), amount = 0.1), jitter(log(control$mean_daily_comments_instudy), amount = 0.1), xlab = "Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Control", pch = 16, col = colors['control'])
# abline(0,1)
# plot(jitter(log(moderation$mean_daily_comments_prestudy), amount = 0.1), jitter(log(moderation$mean_daily_comments_instudy), amount = 0.1), xlab = "Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Moderation", pch = 16, col = colors['moderation'])
# abline(0,1)
# plot(jitter(log(incentives$mean_daily_comments_prestudy), amount = 0.1), jitter(log(incentives$mean_daily_comments_instudy), amount = 0.1), xlab = "Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Incentives", pch = 16, col = colors['incentives'])
# abline(0,1)


```



```{r, fig.width=10, fig.height=5}
# copy of 3-gang version subset by condition
par(pty="s", mfrow = c(1,3), cex = .6)
plot(log(control$mean_daily_comments_prestudy), log(control$mean_daily_comments_instudy), xlab = "Logged Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Control", pch = 16, col = colors['control'])
abline(0,1)
plot(log(moderation$mean_daily_comments_prestudy), log(moderation$mean_daily_comments_instudy), xlab = "Logged Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Moderation", pch = 16, col = colors['moderation'])
abline(0,1)
plot(log(incentives$mean_daily_comments_prestudy), log(incentives$mean_daily_comments_instudy), xlab = "Logged Mean daily comments pre-study", ylab = "Logged mean daily comments in study", main = "Incentives", pch = 16, col = colors['incentives'])
abline(0,1)

```


```{r, fig.width=10, fig.height=5}
# copy of 3-gang version subset by condition, not logged
this_xlim = c(0,12)
this_ylim = c(0,5)

par(pty="s", mfrow = c(1,3), cex = .6)
plot((control$mean_daily_comments_prestudy), (control$mean_daily_comments_instudy), xlab = "Mean daily comments pre-study", ylab = "Mean daily comments in study", main = "Control", pch = 16, col = colors['control'], xlim = this_xlim, ylim = this_ylim)
abline(0,1)
plot((moderation$mean_daily_comments_prestudy), (moderation$mean_daily_comments_instudy), xlab = "Mean daily comments pre-study", ylab = "Mean daily comments in study", main = "Moderation", pch = 16, col = colors['moderation'], xlim = this_xlim, ylim = this_ylim)
abline(0,1)
plot((incentives$mean_daily_comments_prestudy), (incentives$mean_daily_comments_instudy), xlab = "Mean daily comments pre-study", ylab = "Mean daily comments in study", main = "Incentives", pch = 16, col = colors['incentives'], xlim = this_xlim, ylim = this_ylim)
abline(0,1)

```




```{r}
#plot ratio by prestudy
s <- s %>% mutate(prestudy_instudy_comment_ratio = mean_daily_comments_instudy/mean_daily_comments_prestudy)

control <- s %>% filter(condition == "control")
moderation <- s %>% filter(condition == "moderation")
incentives <- s %>% filter(condition == "incentives")

par(cex = .8)
plot(control$mean_daily_comments_prestudy, control$prestudy_instudy_comment_ratio, xlab = "Mean daily comments pre-study", ylab = "In-Study/Pre-Study", main = "Mean daily comments in study / pre-study ", pch = 16, col = colors['control'])
points(moderation$mean_daily_comments_prestudy, moderation$prestudy_instudy_comment_ratio, pch = 16, col = colors['moderation'])
points(incentives$mean_daily_comments_prestudy, incentives$prestudy_instudy_comment_ratio, pch = 16, col = colors['incentives'])

```



```{r, fig.width=14, fig.height=8}
#plot difference by prestudy
s <- s %>% mutate(prestudy_instudy_comment_difference = mean_daily_comments_instudy-mean_daily_comments_prestudy)

control <- s %>% filter(condition == "control")
moderation <- s %>% filter(condition == "moderation")
incentives <- s %>% filter(condition == "incentives")

par(cex = .8)
plot(control$mean_daily_comments_prestudy, control$prestudy_instudy_comment_difference, xlab = "Mean daily comments pre-study", ylab = "In-Study - Pre-Study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['control'])
points(moderation$mean_daily_comments_prestudy, moderation$prestudy_instudy_comment_difference, pch = 16, col = colors['moderation'])
points(incentives$mean_daily_comments_prestudy, incentives$prestudy_instudy_comment_difference, pch = 16, col = colors['incentives'])
abline(h = 0, lty = 2)
abline(0,-1)
```


```{r, fig.width=8, fig.height=10}
# bin differences by intervals of 1 in pre-study comments
s <- s %>% mutate(prestudy_unit_bin = cut(mean_daily_comments_prestudy, breaks = seq(0, 13, by = 1)))

# plot s subsets
control <- s %>% filter(condition == "control") %>% select(prestudy_unit_bin, prestudy_instudy_comment_difference) %>% drop_na()
moderation <- s %>% filter(condition == "moderation") %>% select(prestudy_unit_bin, prestudy_instudy_comment_difference) %>% drop_na()
incentives <- s %>% filter(condition == "incentives") %>% select(prestudy_unit_bin, prestudy_instudy_comment_difference) %>% drop_na()

#fill out the missing bins in control
bins <- s %>% pull(prestudy_unit_bin) %>% unique()
#remove NA values and put in order
bins <- bins[!is.na(bins)]
bins <- bins[order(bins)]
control <- control %>% complete(prestudy_unit_bin = bins)

par(mfrow = c(3,1))

boxplot(prestudy_instudy_comment_difference ~ prestudy_unit_bin, data = control, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['control'], ylim = c(-10,10))
abline(h = 0, lty = 2)
abline(0,-1)

plot(prestudy_instudy_comment_difference ~ prestudy_unit_bin, data = moderation, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['moderation'], ylim = c(-10,10))
abline(h = 0, lty = 2)
abline(0,-1)

plot(prestudy_instudy_comment_difference ~ prestudy_unit_bin, data = incentives, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['incentives'], ylim = c(-10,10))
abline(h = 0, lty = 2)
abline(0,-1)


```


```{r, fig.width=8, fig.height=10}
# make bins based on quantiles

pdf("ws_outputs/comment_diff_by_prestudy_quantile.pdf", width = 8, height = 10)

s <- s %>% mutate(prestudy_quantile_bin = cut(mean_daily_comments_prestudy, breaks = quantile(mean_daily_comments_prestudy, probs = seq(0, 1, by = 0.2), na.rm = TRUE)))

# plot s subsets
control <- s %>% filter(condition == "control") %>% select(prestudy_quantile_bin, prestudy_instudy_comment_difference) %>% drop_na()
moderation <- s %>% filter(condition == "moderation") %>% select(prestudy_quantile_bin, prestudy_instudy_comment_difference) %>% drop_na()
incentives <- s %>% filter(condition == "incentives") %>% select(prestudy_quantile_bin, prestudy_instudy_comment_difference) %>% drop_na()

#fill out the missing bins in control
bins <- s %>% pull(prestudy_quantile_bin) %>% unique()
#remove NA values and put in order
bins <- bins[!is.na(bins)]
bins <- bins[order(bins)]
control <- control %>% complete(prestudy_quantile_bin = bins)

par(mfrow = c(3,1))
this_ylim = c(-10,5)
#this_ylim = NULL

boxplot(prestudy_instudy_comment_difference ~ prestudy_quantile_bin, data = control, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['control'], ylim =this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(prestudy_instudy_comment_difference ~ prestudy_quantile_bin, data = moderation, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['moderation'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(prestudy_instudy_comment_difference ~ prestudy_quantile_bin, data = incentives, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['incentives'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 15, bty = "n")

dev.off()

# s <- s %>% mutate(prestudy_quantile_bin = cut(mean_daily_comments_prestudy, breaks = quantile(mean_daily_comments_prestudy, probs = seq(0, 1, by = 0.25), na.rm = TRUE)))
# 
# # plot s subsets
# control <- s %>% filter(condition == "control") %>% select(prestudy_quantile_bin, prestudy_instudy_comment_difference) %>% drop_na()
# moderation <- s %>% filter(condition == "moderation") %>% select(prestudy_quantile_bin, prestudy_instudy_comment_difference) %>% drop_na()
# incentives <- s %>% filter(condition == "incentives") %>% select(prestudy_quantile_bin, prestudy_instudy_comment_difference) %>% drop_na()
# 
# #fill out the missing bins in control
# bins <- s %>% pull(prestudy_quantile_bin) %>% unique()
# #remove NA values and put in order
# bins <- bins[!is.na(bins)]
# bins <- bins[order(bins)]
# control <- control %>% complete(prestudy_quantile_bin = bins)
# 
# par(mfrow = c(3,1))
# 
# boxplot(prestudy_instudy_comment_difference ~ prestudy_quantile_bin, data = control, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = , ylim = c(-10,5))
# abline(h = 0, lty = 2)
# #abline(0,-1)
# 
# plot(prestudy_instudy_comment_difference ~ prestudy_quantile_bin, data = moderation, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['moderation'], ylim = c(-10,5))
# abline(h = 0, lty = 2)
# #abline(0,-1)
# 
# plot(prestudy_instudy_comment_difference ~ prestudy_quantile_bin, data = incentives, xlab = "Mean daily comments pre-study", ylab = "Difference in comments in-study vs pre-study", main = "Mean daily comments pre-study vs in study", pch = 16, col = colors['incentives'], ylim = c(-10,5))
# abline(h = 0, lty = 2)
# #abline(0,-1)
# 
# legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 15, bty = "n")

```

## WS: Make a Version that is "Probability of Commenting At All on a Given Day"


```{r, fig.width=8, fig.height=10}
# calculated the probability of commenting at all on a given day above, use it now

# duringstudy_int_daily_commentprob
# prestudy_daily_commentprob

pdf("ws_outputs/commentdailyprob_diff_by_prestudy_quantile.pdf", width = 8, height = 10)

s <- s %>% mutate(prestudy_quantile_bin = cut(prestudy_daily_commentprob, breaks = quantile(prestudy_daily_commentprob, probs = seq(0, 1, by = 0.2), na.rm = TRUE))) %>% mutate(prestudy_instudy_commentprob_difference = (duringstudy_int_daily_commentprob - prestudy_daily_commentprob))

# plot s subsets
control <- s %>% filter(condition == "control") %>% select(prestudy_quantile_bin, prestudy_instudy_commentprob_difference) %>% drop_na()
moderation <- s %>% filter(condition == "moderation") %>% select(prestudy_quantile_bin, prestudy_instudy_commentprob_difference) %>% drop_na()
incentives <- s %>% filter(condition == "incentives") %>% select(prestudy_quantile_bin, prestudy_instudy_commentprob_difference) %>% drop_na()

#fill out the missing bins in control
bins <- s %>% pull(prestudy_quantile_bin) %>% unique()
#remove NA values and put in order
bins <- bins[!is.na(bins)]
bins <- bins[order(bins)]
control <- control %>% complete(prestudy_quantile_bin = bins)

par(mfrow = c(3,1))
this_ylim = c(-1,1)
this_xlab = "Pre-Study Probability of Commenting At All on a Given Day"
this_ylab = "P(comment > 0/day | int) - P(comment > 0/day | ext)"
this_main = "Probability of Commenting At least Once per Day"

boxplot(prestudy_instudy_commentprob_difference ~ prestudy_quantile_bin, data = control, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['control'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(prestudy_instudy_commentprob_difference ~ prestudy_quantile_bin, data = moderation, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['moderation'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(prestudy_instudy_commentprob_difference ~ prestudy_quantile_bin, data = incentives, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['incentives'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 15, bty = "n")


dev.off()

```


```{r, fig.width=8, fig.height=10}
# version with external duringstudy reference point

s <- s %>% mutate(duringstudy_ext_quantile_bin = cut(duringstudy_ext_daily_commentprob, breaks = quantile(duringstudy_ext_daily_commentprob, probs = seq(0, 1, by = 0.2), na.rm = TRUE))) %>% mutate(extstudy_instudy_commentprob_difference = (duringstudy_int_daily_commentprob - duringstudy_ext_daily_commentprob))

# plot s subsets
control <- s %>% filter(condition == "control") %>% select(duringstudy_ext_quantile_bin, extstudy_instudy_commentprob_difference) %>% drop_na()
moderation <- s %>% filter(condition == "moderation") %>% select(duringstudy_ext_quantile_bin, extstudy_instudy_commentprob_difference) %>% drop_na()
incentives <- s %>% filter(condition == "incentives") %>% select(duringstudy_ext_quantile_bin, extstudy_instudy_commentprob_difference) %>% drop_na()

#fill out the missing bins in control
bins <- s %>% pull(duringstudy_ext_quantile_bin) %>% unique()
#remove NA values and put in order
bins <- bins[!is.na(bins)]
bins <- bins[order(bins)]
control <- control %>% complete(duringstudy_ext_quantile_bin = bins)

par(mfrow = c(3,1))
this_ylim = c(-1,1)
this_xlab = "Pre-Study Probability of Commenting At All on a Given Day"
this_ylab = "P(comment > 0/day | int) - P(comment > 0/day | ext)"
this_main = "Probability of Commenting At least Once per Day"

boxplot(extstudy_instudy_commentprob_difference ~ duringstudy_ext_quantile_bin, data = control, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['control'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(extstudy_instudy_commentprob_difference ~ duringstudy_ext_quantile_bin, data = moderation, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['moderation'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(extstudy_instudy_commentprob_difference ~ duringstudy_ext_quantile_bin, data = incentives, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['incentives'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 15, bty = "n")


```


### Make Raw non-diff versions


```{r, fig.width=8, fig.height=10}
pdf("ws_outputs/comment_raw_by_prestudy_quantile.pdf", width = 8, height = 10)

s <- s %>% mutate(prestudy_quantile_bin = cut(mean_daily_comments_prestudy, breaks = quantile(mean_daily_comments_prestudy, probs = seq(0, 1, by = 0.25), na.rm = TRUE)))

# plot s subsets
control <- s %>% filter(condition == "control") %>% select(prestudy_quantile_bin, mean_daily_comments_instudy) %>% drop_na()
moderation <- s %>% filter(condition == "moderation") %>% select(prestudy_quantile_bin, mean_daily_comments_instudy) %>% drop_na()
incentives <- s %>% filter(condition == "incentives") %>% select(prestudy_quantile_bin, mean_daily_comments_instudy) %>% drop_na()

#fill out the missing bins in control
bins <- s %>% pull(prestudy_quantile_bin) %>% unique()
#remove NA values and put in order
bins <- bins[!is.na(bins)]
bins <- bins[order(bins)]
control <- control %>% complete(prestudy_quantile_bin = bins)

par(mfrow = c(3,1))
this_ylim = c(0,4)
#this_ylim = NULL

this_xlab = "Pre-Study Mean Daily Comments"
this_ylab = "In-Study Mean Daily Comments"
this_main = "Pre-Study vs In-Study Mean Daily Comments"

boxplot(mean_daily_comments_instudy ~ prestudy_quantile_bin, data = control, xlab =this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['control'], ylim =this_ylim)
#abline(h = 0, lty = 2)
#abline(0,-1)

plot(mean_daily_comments_instudy ~ prestudy_quantile_bin, data = moderation, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['moderation'], ylim = this_ylim)
#abline(h = 0, lty = 2)
#abline(0,-1)

plot(mean_daily_comments_instudy ~ prestudy_quantile_bin, data = incentives, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['incentives'], ylim = this_ylim)
#abline(h = 0, lty = 2)
#abline(0,-1)

legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 15, bty = "n")

dev.off()

```


```{r, fig.width=8, fig.height=10}
pdf("ws_outputs/commentdailyprob_raw_by_prestudy_quantile.pdf", width = 8, height = 10)

s <- s %>% mutate(prestudy_quantile_bin = cut(prestudy_daily_commentprob, breaks = quantile(prestudy_daily_commentprob, probs = seq(0, 1, by = 0.25), na.rm = TRUE)))

# plot s subsets
control <- s %>% filter(condition == "control") %>% select(prestudy_quantile_bin, duringstudy_int_daily_commentprob) %>% drop_na()
moderation <- s %>% filter(condition == "moderation") %>% select(prestudy_quantile_bin, duringstudy_int_daily_commentprob) %>% drop_na()
incentives <- s %>% filter(condition == "incentives") %>% select(prestudy_quantile_bin, duringstudy_int_daily_commentprob) %>% drop_na()

#fill out the missing bins in control
bins <- s %>% pull(prestudy_quantile_bin) %>% unique()
#remove NA values and put in order
bins <- bins[!is.na(bins)]
bins <- bins[order(bins)]
control <- control %>% complete(prestudy_quantile_bin = bins)

par(mfrow = c(3,1))
this_ylim = c(0,1)
this_xlab = "Pre-Study Probability of Commenting At All on a Given Day"
this_ylab = "In-Study Probability of Commenting At All on a Given Day"
this_main = "Pre-Study vs In-Study Probability of Commenting At least Once per Day"

boxplot(duringstudy_int_daily_commentprob ~ prestudy_quantile_bin, data = control, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['control'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(duringstudy_int_daily_commentprob ~ prestudy_quantile_bin, data = moderation, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['moderation'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

plot(duringstudy_int_daily_commentprob ~ prestudy_quantile_bin, data = incentives, xlab = this_xlab, ylab = this_ylab, main = this_main, pch = 16, col = colors['incentives'], ylim = this_ylim)
abline(h = 0, lty = 2)
#abline(0,-1)

legend("topright", legend = c("Control", "Moderation", "Incentives"), col = c(colors['control'], colors['moderation'], colors['incentives']), pch = 15, bty = "n")


dev.off()

```


```{r}


```



# WS: Commenting activity over time

```{r}
#all_data
#internal_comments

test_ParticipantID <- "4aa8b19edf"

test_comments <- internal_comments %>% filter(ParticipantID == test_ParticipantID) %>% select(created_comment, comment_toxicity, length_comment_char) %>% arrange(created_comment)

test_comments

#plot each comment as a point on a timeline
plot(test_comments$created_comment, rep(0, length(test_comments$created_comment)), type = "p", pch = "|", col = rgb(0,0,0,.8), xlab = "Date", ylab = "Toxicity")

```


```{r}
internal_comments_augmented <- left_join(internal_comments, sample, by = "ParticipantID")

#find the subreddits in each condition
internal_comments_augmented %>% group_by(subreddit, condition) %>% dplyr::summarize(n = n())

control_1 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics1")
control_6 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics6")
moderation_2 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics2")
moderation_5 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics5")
incentives_3 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics3")
incentives_4 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics4")

```


```{r}
#plot each comment from control_1 as a point on a timeline, with a different vertical row for each ParticipantID

#prepare a vector of y-values for each participant
participant_heights <- 1:length(unique(control_1$ParticipantID))
names(participant_heights) <- unique(control_1$ParticipantID)
#reorder by total comment count
participant_heights <- participant_heights[order(table(control_1$ParticipantID), decreasing = TRUE)]

plot(control_1$created_comment[1], participant_heights[which(names(participant_heights)==control_1$ParticipantID[1])], type = "p", pch = "|", col = rgb(0,0,0,.8), xlab = "Date", ylab = "ParticipantID", ylim = c(0, length(participant_heights)), xlim = c(min(control_1$created_comment), max(control_1$created_comment)))

# color the points by toxicity, red to green

for(i in 2:nrow(control_1)){
  points(control_1$created_comment[i], participant_heights[which(names(participant_heights)==control_1$ParticipantID[i])], type = "p", pch = "|", col = rgb(control_1$comment_toxicity[i],1-control_1$comment_toxicity[i],0,.8))
}

```


```{r}
#wrap this up in a function that I can pass any dataframe to
plot_comments <- function(data, main, bg = "black", xlim = NULL){
  # filter data to remove NA toxicity values
  data <- data %>% filter(!is.na(comment_toxicity))
  participant_heights <- 1:length(unique(data$ParticipantID))
  names(participant_heights) <- unique(data$ParticipantID)
  participant_heights <- participant_heights[order(table(data$ParticipantID), decreasing = TRUE)]
  par(bg = bg)
  if(is.null(xlim)){
    xlim <- c(min(data$created_comment), max(data$created_comment))
  }
  plot(data$created_comment[1], participant_heights[which(names(participant_heights)==data$ParticipantID[1])], type = "p", pch = "|", col = rgb(0,0,0,.8), xlab = "Date", ylab = "ParticipantID", ylim = c(0, length(participant_heights)), xlim = c(min(data$created_comment), max(data$created_comment)), main = main)
  
  for(i in 2:nrow(data)){
    points(data$created_comment[i], participant_heights[which(names(participant_heights)==data$ParticipantID[i])], type = "p", pch = "|", col = rgb(data$comment_toxicity[i],1-data$comment_toxicity[i],0,.8))
  }
}

data = control_1
ycolumn = "comment_toxicity"

control_1 %>% group_by(ParticipantID) %>% dplyr::summarize(mean_comment_toxicity = mean(comment_toxicity, na.rm = TRUE)) %>% arrange(desc(mean_comment_toxicity))

plot_comments <- function(data, ycolumn, main, bg = "black", xlim = NULL){
  # filter data to remove NA toxicity values
  data <- data %>% filter(!is.na(comment_toxicity))
  participant_heights <- 1:length(unique(data$ParticipantID))
  #names(participant_heights) <- unique(data$ParticipantID)
  #participant_heights <- participant_heights[order(table(data$ParticipantID), decreasing = TRUE)]
  #sort the data by the values in its column with name equal to the ycolumn argument
  names_for_participant_heights <- data %>% group_by(ParticipantID) %>% dplyr::summarize(height = mean(data[[ycolumn]], na.rm = TRUE)) %>% arrange(desc(height)) %>% pull(ParticipantID)
  names(participant_heights) <- names_for_participant_heights
  par(bg = bg)
  if(is.null(xlim)){
    xlim <- c(min(data$created_comment), max(data$created_comment))
  }
  plot(data$created_comment[1], participant_heights[which(names(participant_heights)==data$ParticipantID[1])], type = "p", pch = "|", col = rgb(0,0,0,.8), xlab = "Date", ylab = "ParticipantID", ylim = c(0, length(participant_heights)), xlim = c(min(data$created_comment), max(data$created_comment)), main = main)
  
  for(i in 2:nrow(data)){
    points(data$created_comment[i], participant_heights[which(names(participant_heights)==data$ParticipantID[i])], type = "p", pch = "|", col = rgb(data$comment_toxicity_rescaled[i],1-data$comment_toxicity_rescaled[i],0,.8))
  }
}
```


```{r}
#internal_comments_augmented <- left_join(internal_comments, sample, by = "ParticipantID")
internal_comments_augmented <- left_join(internal_comments, s, by = "ParticipantID")

# rescale toxicity to 0,1

toxicity_quantiles <- internal_comments_augmented$comment_toxicity %>% quantile(probs = seq(0, 1, by = 0.1), na.rm = TRUE)

internal_comments_augmented <- internal_comments_augmented %>% filter(!is.na(comment_toxicity)) %>% mutate(comment_toxicity_rescaled = cut(comment_toxicity, breaks = toxicity_quantiles, labels = F, include.lowest = TRUE)/10)

# internal_comments_augmented$comment_toxicity_rescaled %>% min
# 
# length(toxicity_quantiles)
# length(seq(0, 1, by = 0.1))
# 
# cut(internal_comments_augmented$comment_toxicity, breaks = toxicity_quantiles, labels = seq(0, 1, by = 0.1), include.lowest = TRUE)
# 
# hist(internal_comments_augmented$comment_toxicity)
# abline(v = toxicity_quantiles, col = "red")
# 
# testcut <- cut(internal_comments_augmented$comment_toxicity, breaks = toxicity_quantiles, labels = F, include.lowest = TRUE)
# 
# unique(testcut) %>% length
# 
# internal_comments_augmented <- internal_comments_augmented %>% mutate(comment_toxicity_rescaled = NA)

#find the subreddits in each condition
internal_comments_augmented %>% group_by(subreddit, condition) %>% dplyr::summarize(n = n())

control_1 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics1")
control_6 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics6")
moderation_2 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics2")
moderation_5 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics5")
incentives_3 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics3")
incentives_4 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics4")

```


```{r}
internal_comments_augmented$comment_toxicity_rescaled %>% hist

```


```{r, fig.height=10, fig.width=8}
#apply to each dataframe, layout 2*3
par(mfrow = c(3,2))
bgcol = "black"

this_ycolumn <- "mean_daily_comments_prestudy"
#this_ycolumn <- "affective_polarization"


plot_comments(control_1, ycolumn = this_ycolumn, main = "Control A", bg = bgcol)
plot_comments(control_6, ycolumn = this_ycolumn, main = "Control B", bg = bgcol)

plot_comments(moderation_2, ycolumn = this_ycolumn, main = "Moderation A", bg = bgcol)
plot_comments(moderation_5, ycolumn = this_ycolumn, main = "Moderation B", bg = bgcol)

plot_comments(incentives_3, ycolumn = this_ycolumn, main = "Incentives A", bg = bgcol)
plot_comments(incentives_4, ycolumn = this_ycolumn, main = "Incentives B", bg = bgcol)


```


## WS More Color Adjustments

```{r}
data = control_1
ycolumn = "comment_mean_tox"
main = "test plot"
bg = "black"
fg = "white"
xlim = NULL

plot_comments <- function(data, ycolumn, color_column, main, pch = "|", bg = "black", fg = "white", xlim = NULL){
  # filter data to remove NA toxicity values
  data <- data %>% filter(!is.na(comment_toxicity))
  #participant_heights <- 1:length(unique(data$ParticipantID))
  #names(participant_heights) <- unique(data$ParticipantID)
  #participant_heights <- participant_heights[order(table(data$ParticipantID), decreasing = TRUE)]
  #sort the data by the values in its column with name equal to the ycolumn argument
  #names_for_participant_heights <- data %>% group_by(ParticipantID) %>% dplyr::summarize(height = mean(.[[ycolumn]], na.rm = TRUE)) %>% arrange(desc(height)) %>% pull(ParticipantID)
  #names(participant_heights) <- names_for_participant_heights
  ycolumn_sym <- sym(ycolumn)
  names_for_participant_heights <- data %>% group_by(ParticipantID) %>% dplyr::summarize(height = mean({{ycolumn_sym}}, na.rm = TRUE)) %>% arrange((height)) %>% pull(ParticipantID)
  #participant_heights <- participant_heights[order(match(names_for_participant_heights, names(participant_heights)))]
  participant_heights <- 1:length(names_for_participant_heights)
  names(participant_heights) <- names_for_participant_heights
  par(bg = bg)
  par(bg = bg, col.axis = fg, col.lab = fg, col.main = fg, col.sub = fg)
  if(is.null(xlim)){
    xlim <- c(min(data$created_comment), max(data$created_comment))
  }
  color_column_sym <- sym(color_column)
  
  plot(data$created_comment[1], participant_heights[which(names(participant_heights)==data$ParticipantID[1])], type = "p", pch = pch, col = rgb(0,0,0,0), xlab = "Date", ylab = "ParticipantID", ylim = c(0, length(participant_heights)), xlim = c(min(data$created_comment), max(data$created_comment)), main = main)
  
  for(i in 1:nrow(data)){
    points(data$created_comment[i], participant_heights[which(names(participant_heights)==data$ParticipantID[i])], type = "p", pch = pch, col = rgb(data[[color_column_sym]][i],1-data[[color_column_sym]][i],0,.8))
  }
  axis(1, col = fg, col.axis = NA, col.ticks = NA) # X-axis
  axis(2, col = fg, col.axis = NA, col.ticks = NA)
}


```




```{r}
# continue augmenting

length_comment_char_quantiles <- internal_comments_augmented$length_comment_char %>% quantile(probs = seq(0, 1, by = 0.1), na.rm = TRUE)

# add
internal_comments_augmented <- internal_comments_augmented %>% filter(!is.na(length_comment_char)) %>% mutate(length_comment_char_rescaled = cut(length_comment_char, breaks = length_comment_char_quantiles, labels = F, include.lowest = TRUE)/10)

internal_comments_augmented <- left_join(internal_comments_augmented, (internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(first_comment_posted = min(created_comment), last_comment_posted = max(created_comment))))

#find the subreddits in each condition
#internal_comments_augmented %>% group_by(subreddit, condition) %>% dplyr::summarize(n = n())

control_1 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics1")
control_6 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics6")
moderation_2 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics2")
moderation_5 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics5")
incentives_3 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics3")
incentives_4 <- internal_comments_augmented %>% filter(subreddit == "DiscussPolitics4")

control_1
```



```{r, fig.height=10, fig.width=8}
#apply to each dataframe, layout 2*3
par(mfrow = c(3,2), cex = .4)
bgcol = "black"
fgcol = "white"

#this_ycolumn <- "mean_daily_comments_prestudy"
#this_ycolumn <- "affective_polarization"
#this_ycolumn <- "comment_toxicity"
#this_ycolumn <- "affective_pol_1"
#this_ycolumn <- "comment_mean_tox"
#this_ycolumn <- "in_party_feel"
#this_ycolumn <- "out_party_feel"
#this_ycolumn <- "first_comment_posted"
#this_ycolumn <- "last_comment_posted"
this_ycolumn <- "gender"

#this_color_column <- "comment_toxicity_rescaled"
this_color_column <- "length_comment_char_rescaled"

plot_comments(control_1, ycolumn = this_ycolumn, color_column = this_color_column, main = "Control A", bg = bgcol, fg = fgcol, pch = 16)
plot_comments(control_6, ycolumn = this_ycolumn, color_column = this_color_column, main = "Control B", bg = bgcol, fg = fgcol, pch = 16)

plot_comments(moderation_2, ycolumn = this_ycolumn, color_column = this_color_column, main = "Moderation A", bg = bgcol, fg = fgcol, pch = 16)
plot_comments(moderation_5, ycolumn = this_ycolumn, color_column = this_color_column, main = "Moderation B", bg = bgcol, fg = fgcol, pch = 16)

plot_comments(incentives_3, ycolumn = this_ycolumn, color_column = this_color_column, main = "Incentives A", bg = bgcol, fg = fgcol, pch = 16)
plot_comments(incentives_4, ycolumn = this_ycolumn, color_column = this_color_column, main = "Incentives B", bg = bgcol, fg = fgcol, pch = 16)


```

## WS: Adaptable Vertical Ordering


```{r}
data = control_1
ycolumn = "comment_mean_tox"
main = "test plot"
bg = "black"
fg = "white"
xlim = NULL

data = data %>% group_by(ParticipantID) %>% dplyr::summarize(height = mean(last_comment_posted, na.rm = TRUE)) %>% arrange((height))

#data$gender

#ordered_ids = data %>% group_by(ParticipantID) %>% dplyr::summarize(height = mean(last_comment_posted, na.rm = TRUE)) %>% arrange((height)) %>% pull(ParticipantID)

plot_comments <- function(data, names_for_participant_heights, color_column, main, pch = "|", bg = "black", fg = "white", xlim = NULL){
  # filter data to remove NA toxicity values
  data <- data# %>% filter(!is.na(comment_toxicity))
  names_for_participant_heights <- names_for_participant_heights[which(names_for_participant_heights %in% data$ParticipantID)]
  participant_heights <- 1:length(names_for_participant_heights)
  names(participant_heights) <- names_for_participant_heights
  par(bg = bg)
  par(bg = bg, col.axis = fg, col.lab = fg, col.main = fg, col.sub = fg)
  if(is.null(xlim)){
    xlim <- c(min(data$created_comment), max(data$created_comment))
  }
  color_column_sym <- sym(color_column)
  
  plot(data$created_comment[1], participant_heights[which(names(participant_heights)==data$ParticipantID[1])], type = "p", pch = pch, col = rgb(0,0,0,0), xlab = "Date", ylab = "ParticipantID", ylim = c(0, length(participant_heights)), xlim = c(min(data$created_comment), max(data$created_comment)), main = main)
  
  for(i in 1:nrow(data)){
    points(data$created_comment[i], participant_heights[which(names(participant_heights)==data$ParticipantID[i])], type = "p", pch = pch, col = rgb(data[[color_column_sym]][i],1-data[[color_column_sym]][i],0,.8))
  }
  axis(1, col = fg, col.axis = NA, col.ticks = NA) # X-axis
  axis(2, col = fg, col.axis = NA, col.ticks = NA)
}


```




```{r, fig.height=10, fig.width=8}
# #apply to each dataframe, layout 2*3
par(mfrow = c(3,2), cex = .3)
bgcol = "black"
fgcol = "white"
this_pch = "|"

#this_ycolumn <- "mean_daily_comments_prestudy"
#this_ycolumn <- "affective_polarization"
#this_ycolumn <- "comment_toxicity"
#this_ycolumn <- "affective_pol_1"
#this_ycolumn <- "comment_mean_tox"
#this_ycolumn <- "in_party_feel"
#this_ycolumn <- "out_party_feel"
#this_ycolumn <- "first_comment_posted"
#this_ycolumn <- "last_comment_posted"
#this_ycolumn <- "gender"

this_color_column <- "comment_toxicity_rescaled"
#this_color_column <- "length_comment_char_rescaled"

#participant_order <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(gender = mean(gender), last_comment_posted = mean(last_comment_posted), na.rm = TRUE) %>% arrange(gender, last_comment_posted) %>% pull(ParticipantID)
#participant_order <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(gender = mean(gender), mean_daily_comments_prestudy = mean(mean_daily_comments_prestudy), na.rm = TRUE) %>% arrange(gender, mean_daily_comments_prestudy) %>% pull(ParticipantID)

#participant_order <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(polinterest = mean(polinterest), na.rm = TRUE) %>% arrange(polinterest) %>% drop_na() %>% pull(ParticipantID)

# redo this with # comments outside study during study period
#participant_order <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(mean_daily_comments_prestudy = mean(mean_daily_comments_prestudy), na.rm = TRUE) %>% arrange(mean_daily_comments_prestudy) %>% pull(ParticipantID)

ordering_df <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(mean_daily_comments_extstudy = mean(mean_daily_comments_extstudy, na.rm = TRUE)) %>% filter(!is.na(ParticipantID))

ordering_df$mean_daily_comments_extstudy[which(is.nan(ordering_df$mean_daily_comments_extstudy))] <- 0

participant_order <- ordering_df %>% filter() %>% arrange(mean_daily_comments_extstudy) %>% pull(ParticipantID)

these_internal_comments_augmented <- internal_comments_augmented %>% filter(ParticipantID %in% participant_order)

control_1 <- these_internal_comments_augmented %>% filter(subreddit == "DiscussPolitics1")
control_6 <- these_internal_comments_augmented %>% filter(subreddit == "DiscussPolitics6")
moderation_2 <- these_internal_comments_augmented %>% filter(subreddit == "DiscussPolitics2")
moderation_5 <- these_internal_comments_augmented %>% filter(subreddit == "DiscussPolitics5")
incentives_3 <- these_internal_comments_augmented %>% filter(subreddit == "DiscussPolitics3")
incentives_4 <- these_internal_comments_augmented %>% filter(subreddit == "DiscussPolitics4")

plot_comments(control_1,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Control A", bg = bgcol, fg = fgcol, pch = this_pch)
plot_comments(control_6,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Control B", bg = bgcol, fg = fgcol, pch = this_pch)

plot_comments(moderation_2,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Moderation A", bg = bgcol, fg = fgcol, pch = this_pch)
plot_comments(moderation_5,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Moderation B", bg = bgcol, fg = fgcol, pch = this_pch)

plot_comments(incentives_3,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Incentives A", bg = bgcol, fg = fgcol, pch = this_pch)
plot_comments(incentives_4,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Incentives B", bg = bgcol, fg = fgcol, pch = this_pch)


```


```{r}
plot(internal_comments_augmented$mean_daily_comments_instudy, internal_comments_augmented$comment_mean_tox)

plot(internal_comments_augmented$comment_mean_tox, internal_comments_augmented$mean_daily_comments_instudy)


#to do: make a variable that is "fraction of comments they account for on their subreddit"
```


```{r}
#simple plot of polinterest vs comment count
toplot <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(polinterest = mean(polinterest), comment_count = mean(comment_count))
boxplot(toplot$comment_count ~ toplot$polinterest)

#simple plot of gender vs comment_mean_tox
toplot <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(gender = mean(gender), comment_mean_tox = mean(comment_mean_tox))
boxplot(toplot$comment_mean_tox ~ toplot$gender)

#simple plot of affective_polarization vs comment_mean_tox
toplot <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(affective_polarization = mean(affective_polarization), comment_mean_tox = mean(comment_mean_tox))
plot(toplot$affective_polarization, toplot$comment_mean_tox)

#simple plot of polinterest vs comment_mean_tox
toplot <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(polinterest = mean(polinterest), comment_mean_tox = mean(comment_mean_tox))
boxplot(toplot$comment_mean_tox ~ toplot$polinterest)

#subdivide by gender
toplot <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(polinterest = mean(polinterest), comment_mean_tox = mean(comment_mean_tox), gender = mean(gender))
boxplot(comment_mean_tox ~ polinterest + gender, data = toplot)

```


```{r}
internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(gender = mean(gender), comment_mean_tox = mean(comment_mean_tox), na.rm = TRUE) %>% arrange(gender, comment_mean_tox)


internal_comments_augmented
```



```{r}
s

#interesting variable: polinterest, trust, affective_polarization, efficacy 
```

```{r}
plot(s$affective_polarization, s$comment_mean_tox)

plot(s$affective_polarization, s$affective_pol_1)

plot(s$affective_polarization, s$in_party_feel)
plot(s$affective_polarization, s$out_party_feel)

```





# Other survey descriptives

## Online activity
```{r, fig.width=12, fig.height=3}
a <- ggplot(sample)+
  geom_bar(aes(time_online), fill = "#6699FF")+
  theme_bw()+
  coord_flip()+
  xlab("")+
  ylab("")+
  labs(title = "Time online")+
  annotate(geom="text", x = 2, y = 0, hjust = 0, label = "Up to one hour per week")+
  annotate(geom="text", x = 3, y = 0, hjust = 0, label = "Up to one hour per day")+
  annotate(geom="text", x = 4, y = 0, hjust = 0, label = "Multiple hours per day")+
  annotate(geom="text", x = 5, y = 0, hjust = 0, label = "Almost the entire day")


b <- ggplot(sample)+
  geom_bar(aes(social_media), fill = "#6699FF")+
  theme_bw()+
  coord_flip()+
  xlab("")+
  labs(title = "Social media use")+
  annotate(geom="text", x = 2, y = 0, hjust = 0, label = "A couple of times per week")+
  annotate(geom="text", x = 3, y = 0, hjust = 0, label = "About once per day")+
  annotate(geom="text", x = 4, y = 0, hjust = 0, label = "Multiple times per day")+
  annotate(geom="text", x = 5, y = 0, hjust = 0, label = "Almost constantly")+
  ylab("")

c <- ggplot(sample)+
  geom_bar(aes(comments_online), fill = "#6699FF")+
  theme_bw()+
  coord_flip()+
  xlab("")+
  ylab("")+
  labs(title = "Commenting online")+
  annotate(geom="text", x = 1, y = 0, hjust = 0, label = "Never")+
  annotate(geom="text", x = 2, y = 0, hjust = 0, label = "About once per month")+
  annotate(geom="text", x = 3, y = 0, hjust = 0, label = "About once per week")+
  annotate(geom="text", x = 4, y = 0, hjust = 0, label = "Almost daily")+
  annotate(geom="text", x = 5, y = 0, hjust = 0, label = "Multiple times per day")

abc <- grid.arrange(a, b, c, nrow = 1)
ggsave("../output/online_activity.pdf", abc, width = 10 , height = 3) 
```


```{r, fig.width=12, fig.height=4}
# affective polarization
parties <- ggplot(sample)+
  geom_density(aes(affective_pol_1),fill = "#6699ff", alpha = 0.5)+
  geom_density(aes(affective_pol_2),fill = "#bc3455", alpha = 0.5)+
  theme_bw()+
  ylab("")+
  annotate(geom = "text", x = 10, y = 0.04, hjust = 0,  label = "Rating of Republican Party")+
  annotate(geom = "text", x = 60, y = 0.02, hjust = 0, label = "Rating of Democratic Party")+
  xlab("Party Rating: 0 = negative, 100 = positive")

dist <- ggplot(sample, aes(affective_polarization))+
  geom_density(fill = '#a7aabd', alpha = 0.5)+
  theme_bw()+
  xlab("Affective Polarization (In party - out party)")

polint <- grid.arrange(parties, dist, nrow = 1, top = "Affective Polarization")

ggsave("../output/polarization.pdf", polint, width = 10 , height = 5)
```



## Attitude grids
```{r}
# trust matrix 
trust <- sample %>% 
  dplyr::select(trust_general_1:trust_general_4)%>%
  rename(`Politics` = trust_general_1,
         `Media` = trust_general_2,
         `Science` = trust_general_3,
         `People generally` = trust_general_4)%>%
  # change 1: convert haven_labelled variables to factors 
  as_factor() %>% 
  pivot_longer(
    cols = 1:4,
    names_to = "Variable",
    values_to = "Agreement"
  ) %>% 
  count(Variable, Agreement) %>% 
  ggplot(aes(y = n, x = Agreement)) +
  facet_wrap(. ~ Variable) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("1: Not at all, 2: A little, 3: Quite a bit, 4: Very much")+
  ggtitle("Trust")+
  theme_bw()
trust

ggsave("../output/trust_matrix.pdf", trust, width = 4 , height = 5)
```


```{r, fig.width=7, fig.height=7}
## issue knowledge 
knowledge <- sample %>% 
  dplyr::select(issue_knowledge_loan:issue_knowledge_socialmedia)%>%
  rename_at(1:20, list(~ substr(., 17, nchar(.))))%>%
  as_factor() %>% 
  pivot_longer( cols = 1:20,
    names_to = "Variable",
    values_to = "Knowledge") %>% 
  count(Variable, Knowledge) %>% 
  ggplot(aes(y = n, x = Knowledge)) +
  facet_wrap(. ~ Variable) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("1: Nothing, 2: A little, 3: A moderate amoung, 4: A lot")+
  ggtitle("Issue Knowledge T1")+
  theme_bw()
knowledge

ggsave("../output/knowledge_matrix.pdf", knowledge, width = 10 , height = 8)
```


```{r, fig.width=7, fig.height=7}
## issue attitudes 
attitudes <- sample %>% 
  dplyr::select(issue_attitudes_loan:issue_attitudes_socialmedia)%>%
  rename_at(1:20, list(~ substr(., 17, nchar(.))))%>%
  as_factor() %>% 
  pivot_longer(cols = 1:20,
    names_to = "Variable",
    values_to = "Attitude") %>% 
  count(Variable, Attitude) %>% 
  ggplot(aes(y = n, x = Attitude)) +
  facet_wrap(. ~ Variable) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("1: Strongly disagree - 6: Strongly agree")+
  ggtitle("Issue Attitudes T1")+
  theme_bw()
attitudes

ggsave("../output/attitudes_matrix.pdf", attitudes, width = 10 , height = 8) 
```

## Check-in Surveys
```{r, fig.width=12, fig.height = 4}
# exposure check
exp <- ggplot(post_surveys)+
  geom_density(aes(exposure_correct, fill = as.factor(survey_week)), alpha = 0.7)+
  theme_bw()+
  ylab("")+
  xlab("Exposure Check: TP - FP, 5 topics, 5 distractors")+
  scale_fill_manual(name = "Discussion week", values = rev(c("#6699FF","#70facb","#29c195","#008a62")))

ggsave("../output/exposure_check.pdf", exp, width = 5, height = 3)

# issue distance
dist_abs <- ggplot(post_surveys)+
  geom_density(aes(issue_distance_abs, fill = as.factor(survey_week)), alpha = 0.7)+
  theme_bw()+
  ylab("")+
  xlab("Absolute Issue Distance: | self - others |, aggregate over 5 topics")+
  scale_fill_manual(name = "Discussion week", values = rev(c("#6699FF","#70facb","#29c195","#008a62")))

plot <- grid.arrange(exp,dist_abs, nrow = 1)

ggsave("../output/issue_distance.pdf", dist_abs, width = 6, height = 4)
```


```{r}
# discussion perception
perceptions <- post_surveys %>% 
  dplyr::select(discussion_percep_1:discussion_percep_3)%>%
  rename(`toxic` = discussion_percep_1,
         `constructive` = discussion_percep_2,
         `enjoyable` = discussion_percep_3)%>%
  as_factor() %>% 
  pivot_longer(cols = 1:3,
    names_to = "Variable",
    values_to = "Perception") %>% 
  count(Variable, Perception) %>% 
  ggplot(aes(y = n, x = Perception)) +
  facet_wrap(. ~ Variable) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("1: Not at all, 2: A little, 3: Quite a bit, 4: Very much")+
  ggtitle("Discussion Perception")+
  theme_bw()

ggsave("../output/discussion_perception.pdf", perceptions, width = 6 , height = 4)
```


```{r, fig.width=12, fig.height = 4}
# group perception
perceptions_g <- post_surveys %>% 
  dplyr::select(group_percep_1:group_percep_3)%>%
  rename(`respectful` = group_percep_1,
         `polarized` = group_percep_2,
         `knowledgeable` = group_percep_3)%>%
  as_factor() %>% 
  pivot_longer(cols = 1:3,
    names_to = "Variable",
    values_to = "Perception") %>% 
  count(Variable, Perception) %>% 
  ggplot(aes(y = n, x = Perception)) +
  facet_wrap(. ~ Variable) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("1: Not at all, 2: A little, 3: Quite a bit, 4: Very much")+
  ggtitle("Group Perception")+
  theme_bw()

plot <- grid.arrange(perceptions,perceptions_g, nrow = 1)

ggsave("../output/group_perception.pdf", perceptions_g, width = 6 , height = 4)
```


```{r}
# participation
participation <- post_surveys %>% 
  dplyr::select(participation_4:participation_1)%>%
  rename(`checked topics` = participation_4,
         `read some discussions` = participation_5,
         `followed discussions` = participation_6,
         `voted some` = participation_7,
         `voted many` = participation_8,
         `wrote few comments` = participation_9,
         `commented everything` = participation_10,
         `did not participate` = participation_1)%>%
  as_factor() %>% 
  pivot_longer(cols = 1:8,
    names_to = "Variable",
    values_to = "Participation") %>%
  group_by(Variable)%>%
  summarise(Participation = sum(Participation, na.rm = T))%>%
  mutate(Variable = factor(Variable, levels = c("did not participate", "checked topics",
                                                   "read some discussions",
                                                   "followed discussions",
                                                   "voted some",
                                                   "voted many",
                                                   "wrote few comments",
                                                   "commented everything")))%>%
  ggplot(aes(y = Participation, x = reorder(Variable,Participation))) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("")+
  ggtitle("Self-reported participation")+
  theme_bw()+
  coord_flip()

ggsave("../output/participation_check.pdf", participation, width = 6 , height = 4)
```

## Motives for participation (and barriers)
```{r}
# motives 
motives <- post_surveys %>% 
  dplyr::select(post_motives_20:post_motives_51)%>%
  rename(`inform others` = post_motives_20,
         `entertain others` = post_motives_39,
         `express my opinion` = post_motives_40,
         `provoke others` = post_motives_41,
         `express my emotions` = post_motives_42,
         `connect with others` = post_motives_43,
         `deceive others` = post_motives_44,
         `gain attention` = post_motives_45,
         `prove a point` = post_motives_46,
         `cause chaos` = post_motives_47,
         `bring attention to a topic` = post_motives_48,
         `pursuade others` = post_motives_49,
         `surprise or shock others` = post_motives_50,
         `help researchers` = post_motives_51)%>%
  pivot_longer(cols = 1:14,
    names_to = "Motives",
    values_to = "Variable") %>%
  group_by(Motives)%>%
  summarise(Variable = sum(Variable, na.rm = T))%>%
  mutate(Motives = factor(Motives))%>%
  ggplot(aes(x = reorder(Motives,Variable), y = Variable)) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("")+
  ggtitle("Motives for writing comments")+
  theme_bw()+
  coord_flip()

ggsave("../output/motives.pdf", motives, width = 5 , height = 4)
```


```{r, fig.width=12, fig.height=4}
# negative motives / barriers to participation
barriers <- post_surveys %>% 
  dplyr::select(non_participation_2:non_participation_5,non_participation_1)%>%
  rename(`no barriers` = non_participation_1,
         `personally triggered` = non_participation_2,
         `could not add anything` = non_participation_3,
         `intimidated by sophistication` = non_participation_4,
         `afraid of backlash` = non_participation_5)%>%
  pivot_longer(cols = 1:5,
    names_to = "Barriers",
    values_to = "Variable") %>%
  group_by(Barriers)%>%
  summarise(Variable = sum(Variable, na.rm = T))%>%
  mutate(Barriers = factor(Barriers))%>%
  ggplot(aes(y = Variable, x = reorder(Barriers,Variable))) +
  geom_col(fill = "#6699FF")+
  ylab("")+
  xlab("")+
  ggtitle("Barriers to writing comments")+
  theme_bw()+
  coord_flip()

plot <- grid.arrange(participation,motives,barriers, nrow = 1)


ggsave("../output/barriers.pdf", barriers, width = 5 , height = 2)
```


```{r}
## different to normal Reddit experience 
differences <- post_surveys %>% 
  dplyr::select(different_to_real_1:different_to_real_6)%>%
  na.omit()%>%
  rename(`toxicity discussion` = different_to_real_1,
         `constructiveness discussion` = different_to_real_2,
         `enjoyability discussion` = different_to_real_3,
         `knowleadgeability group` = different_to_real_4,
         `polarization group` = different_to_real_5,
         `respectfulness group` = different_to_real_6)%>%
  as_factor() %>% 
  pivot_longer(cols = 1:6,
    names_to = "Variable",
    values_to = "Perception") %>% 
  count(Variable, Perception) %>% 
  mutate(Variable = factor(Variable, levels = c("toxicity discussion",
                                                "constructiveness discussion",
                                                "enjoyability discussion",
                                                "knowleadgeability group",
                                                "polarization group",
                                                "respectfulness group")))%>%
  ggplot(aes(y = n, x = Perception)) +
  facet_wrap(. ~ Variable) +
  geom_col(fill = "#6699FF")+
  #coord_flip()+
  ylab("")+
  xlab("1: Very similar, 2: Somewhat similar, 3: Somewhat different, 4: Very different")+
  ggtitle("Perceived difference to typical experience on Reddit")+
  theme_bw()
differences

ggsave("../output/differences_perception.pdf", differences, width = 6 , height = 5) 
```



#WS: Investigate Post-Study Survey Measures, like Motivations

```{r}
motives
barriers
perceptions
perceptions_g
```


```{r}
ps <- post_surveys

# discussion perception
ps <- ps %>% 
  mutate(`toxic` = as.factor(discussion_percep_1),
         `constructive` = as.factor(discussion_percep_2),
         `enjoyable` = as.factor(discussion_percep_3))

#group perception
ps <- ps %>% 
  mutate(`respectful` = as.factor(group_percep_1),
         `polarized` = as.factor(group_percep_2),
         `knowledgeable` = as.factor(group_percep_3))

#motives
ps <- ps %>% 
  mutate(`inform others` = as.factor(post_motives_20),
         `entertain others` = as.factor(post_motives_39),
         `express my opinion` = as.factor(post_motives_40),
         `provoke others` = as.factor(post_motives_41),
         `express my emotions` = as.factor(post_motives_42),
         `connect with others` = as.factor(post_motives_43),
         `deceive others` = as.factor(post_motives_44),
         `gain attention` = as.factor(post_motives_45),
         `prove a point` = as.factor(post_motives_46),
         `cause chaos` = as.factor(post_motives_47),
         `bring attention to a topic` = as.factor(post_motives_48),
         `pursuade others` = as.factor(post_motives_49),
         `surprise or shock others` = as.factor(post_motives_50),
         `help researchers` = as.factor(post_motives_51))

#barriers
ps <- ps %>% 
  mutate(`no barriers` = as.factor(non_participation_1),
         `personally triggered` = as.factor(non_participation_2),
         `could not add anything` = as.factor(non_participation_3),
         `intimidated by sophistication` = as.factor(non_participation_4),
         `afraid of backlash` = as.factor(non_participation_5))

ps
```

```{r}
ps$ParticipantID %>% unique %>% length

```


```{r}
internal_comments_augmented

```


```{r}
# join ps to internal_comments_augmented
# internal_comments_augmented <- internal_comments_augmented %>% 
#   left_join(ps %>% select(ParticipantID, toxic, constructive, enjoyable, respectful, polarized, knowledgeable, inform others, entertain others, express my opinion, provoke others, express my emotions, connect with others, deceive others, gain attention, prove a point, cause chaos, bring attention to a topic, pursuade others, surprise or shock others, help researchers, no barriers, personally triggered, could not add anything, intimidated by sophistication, afraid of backlash), by = "ParticipantID")

# enclose all elements of select i `...`
internal_comments_augmented <- left_join(internal_comments_augmented, ps %>% filter(survey_week == 4) %>% 
              select(`ParticipantID`, `toxic`, `constructive`, `enjoyable`, `respectful`, `polarized`, `knowledgeable`, `inform others`, `entertain others`, `express my opinion`, `provoke others`, `express my emotions`, `connect with others`, `deceive others`, `gain attention`, `prove a point`, `cause chaos`, `bring attention to a topic`, `pursuade others`, `surprise or shock others`, `help researchers`, `no barriers`, `personally triggered`, `could not add anything`, `intimidated by sophistication`, `afraid of backlash`),
            by = "ParticipantID")

internal_comments_augmented
```

```{r}


```

```{r}
# a good version of the function
color_interpolate <- function(color1, color2, value){
  color1 <- col2rgb(color1)
  color2 <- col2rgb(color2)
  color <- color1 + (color2 - color1) * value
  return(rgb(color[1], color[2], color[3], maxColorValue = 255))
}


plot_comments <- function(data, names_for_participant_heights, color_column, main, color1 = "green", color2 = "red", pch = "|", bg = "black", fg = "white", xlim = NULL, point_size = 1){
  # Filter data to remove NA toxicity values
  data <- data
  names_for_participant_heights <- names_for_participant_heights[which(names_for_participant_heights %in% data$ParticipantID)]
  participant_heights <- 1:length(names_for_participant_heights)
  names(participant_heights) <- names_for_participant_heights
  par(bg = bg)
  par(bg = bg, col.axis = fg, col.lab = fg, col.main = fg, col.sub = fg)
  
  if(is.null(xlim)){
    xlim <- c(min(data$created_comment), max(data$created_comment))
  }
  
  color_column_sym <- sym(color_column)
  
  # Initialize the plot
  plot(data$created_comment[1], participant_heights[which(names(participant_heights) == data$ParticipantID[1])], 
       type = "p", pch = pch, col = rgb(0, 0, 0, 0), 
       xlab = "Date", ylab = "ParticipantID", 
       ylim = c(0, length(participant_heights)), 
       xlim = xlim, 
       main = main, 
       yaxt = "n")
  
  # Add vertical lines at midnight Pacific time
  date_range <- c(lubridate::floor_date(min(data$created_comment), unit = "day"), 
                  lubridate::ceiling_date(max(data$created_comment), unit = "day"))
  date_range <- seq(date_range[1], date_range[2], by = "day")
  date_range_pacific <- with_tz(date_range, tzone = "America/Los_Angeles")
  for(i in date_range_pacific){
    abline(v = i, col = rgb(1, 1, 1, .2), lty = 1)
  }
  
  # Plot posts in rows with adjustable point size
  for(i in 1:nrow(data)){
    points(data$created_comment[i], 
           participant_heights[which(names(participant_heights) == data$ParticipantID[i])], 
           type = "p", pch = pch, 
           col = color_interpolate(color1, color2, data[[color_column_sym]][i]), 
           cex = point_size) # Adjust point size here
  }
  
  # Annotate each row with the ParticipantID in small text right-aligned to the y-axis
  par(xpd = TRUE)
  for(i in participant_heights){
    text(x = xlim[1], y = i, labels = names(participant_heights)[i], pos = 2, cex = 0.5, col = fg)
  }
  par(xpd = FALSE)
  
  axis(1, col = fg, col.axis = NA, col.ticks = NA) # X-axis
}


# Function to create a gradient legend
add_gradient_legend <- function(color1, color2, labels = c("non-toxic", "toxic"), x, y, width, height) {
  # Generate a sequence of colors for the gradient
  n_colors <- 100
  gradient_colors <- sapply(seq(0, 1, length.out = n_colors), function(value) {
    color_interpolate(color1, color2, value)
  })
  
  # Create an image with the gradient
  par(xpd = TRUE) # Allow plotting outside the main plot
  image(
    x = seq(x, x + width, length.out = n_colors), 
    y = c(y, y + height), 
    z = matrix(seq(0, 1, length.out = n_colors), ncol = 1),
    col = gradient_colors,
    add = TRUE
  )
  
  # Add labels for the gradient
  text(x = x, y = y + height / 2, labels = labels[1], pos = 2, cex = 0.8, col = "white") # Left label
  text(x = x + width, y = y + height / 2, labels = labels[2], pos = 4, cex = 0.8, col = "white") # Right label
  par(xpd = FALSE) # Restore default plotting behavior
}

```



```{r, fig.height=12, fig.width=12}
pdf("ws_outputs/plot_comments_toxicity.pdf", width = 12, height = 21)
# #apply to each dataframe, layout 2*3
par(mfrow = c(3,2), cex = .8)
bgcol = "black"
fgcol = "white"
pch = "|"
this_point_size = .8

this_xlim = c(lubridate::floor_date(min(internal_comments_augmented$created_comment), unit = "day"), lubridate::ceiling_date(max(internal_comments_augmented$created_comment), unit = "day"))

#this_ycolumn <- "mean_daily_comments_prestudy"
#this_ycolumn <- "affective_polarization"
#this_ycolumn <- "comment_toxicity"
#this_ycolumn <- "affective_pol_1"
#this_ycolumn <- "comment_mean_tox"
#this_ycolumn <- "in_party_feel"
#this_ycolumn <- "out_party_feel"
#this_ycolumn <- "first_comment_posted"
#this_ycolumn <- "last_comment_posted"
#this_ycolumn <- "gender"

this_color_column <- "comment_toxicity_rescaled"
color1 = "green"
color2 = "red"

# this_color_column <- "length_comment_char_rescaled"
# color1 = "dodgerblue"
# color2 = "gold"

#participant_order <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(gender = mean(gender), last_comment_posted = mean(last_comment_posted), na.rm = TRUE) %>% arrange(gender, last_comment_posted) %>% pull(ParticipantID)
#participant_order <- internal_comments_augmented %>% group_by(ParticipantID) %>% dplyr::summarize(gender = mean(gender), mean_daily_comments_prestudy = mean(mean_daily_comments_prestudy), na.rm = TRUE) %>% arrange(gender, mean_daily_comments_prestudy) %>% pull(ParticipantID)

# filtered_data <- internal_comments_augmented %>% filter(gender %in% c(1,2))
# participant_order <- filtered_data %>% arrange(gender, last_comment_posted) %>% pull(ParticipantID) %>% unique()

# filtered_data <- internal_comments_augmented %>% filter(!is.na(polarized))
# participant_order <- filtered_data %>% arrange(polarized, last_comment_posted) %>% pull(ParticipantID) %>% unique()

# filtered_data <- internal_comments_augmented %>% filter(!is.na(constructive))
# participant_order <- filtered_data %>% arrange(constructive, last_comment_posted) %>% pull(ParticipantID) %>% unique()

# filtered_data <- internal_comments_augmented %>% filter(!is.na(respectful))
# participant_order <- filtered_data %>% arrange(respectful, last_comment_posted) %>% pull(ParticipantID) %>% unique()

participant_order <- filtered_data %>% arrange(last_comment_posted) %>% pull(ParticipantID) %>% unique()

control_1 <- filtered_data %>% filter(subreddit == "DiscussPolitics1")
control_6 <- filtered_data %>% filter(subreddit == "DiscussPolitics6")
moderation_2 <- filtered_data %>% filter(subreddit == "DiscussPolitics2")
moderation_5 <- filtered_data %>% filter(subreddit == "DiscussPolitics5")
incentives_3 <- filtered_data %>% filter(subreddit == "DiscussPolitics3")
incentives_4 <- filtered_data %>% filter(subreddit == "DiscussPolitics4")

plot_comments(control_1,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Control A", bg = bgcol, fg = fgcol, pch = pch, color1 = color1, color2 = color2, xlim = this_xlim, point_size = this_point_size)
plot_comments(control_6,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Control B", bg = bgcol, fg = fgcol, pch = pch, color1 = color1, color2 = color2, xlim = this_xlim, point_size = this_point_size)

plot_comments(moderation_2,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Moderation A", bg = bgcol, fg = fgcol, pch = pch, color1 = color1, color2 = color2, xlim = this_xlim, point_size = this_point_size)
plot_comments(moderation_5,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Moderation B", bg = bgcol, fg = fgcol, pch = pch, color1 = color1, color2 = color2, xlim = this_xlim, point_size = this_point_size)

plot_comments(incentives_3,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Incentives A", bg = bgcol, fg = fgcol, pch = pch, color1 = color1, color2 = color2, xlim = this_xlim, point_size = this_point_size)
plot_comments(incentives_4,
              names_for_participant_heights = participant_order,
              color_column = this_color_column, main = "Incentives B", bg = bgcol, fg = fgcol, pch = pch, color1 = color1, color2 = color2, xlim = this_xlim, point_size = this_point_size)

# Add the gradient legend
add_gradient_legend(
  color1 = "green", 
  color2 = "red", 
  x = mean(filtered_data$created_comment), 
  y = 0,
  width = diff(range(filtered_data$created_comment)) / 5, 
  height = 1
)


dev.off()
# plot_comments(filtered_data,
#               names_for_participant_heights = filtered_data %>% arrange(polarized, last_comment_posted) %>% pull(ParticipantID) %>% unique(),
#               color_column = this_color_column, main = "Control A", bg = bgcol, fg = fgcol, pch = 16)
```




```{r, fig.height=10, fig.width=8}
filtered_data <- internal_comments_augmented %>% filter(gender %in% c(1,2))

plot_comments(filtered_data,
              names_for_participant_heights = filtered_data %>% arrange(gender, last_comment_posted) %>% pull(ParticipantID) %>% unique(),
              color_column = this_color_column, main = "Control A", bg = bgcol, fg = fgcol, pch = 16)

```


## Agg number of posts from users with each motive, by server

```{r}

sums_express_opinion <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_express_opinion = sum(!is.na(`express my opinion`)))
sums_inform_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_inform_others = sum(!is.na(`inform others`)))
sums_help_researchers <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_help_researchers = sum(!is.na(`help researchers`)))
sums_pursuade_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_pursuade_others = sum(!is.na(`pursuade others`)))
sums_bring_attention <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_bring_attention = sum(!is.na(`bring attention to a topic`)))
sums_connect_with_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_connect_with_others = sum(!is.na(`connect with others`)))
sums_express_emotions <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_express_emotions = sum(!is.na(`express my emotions`)))
sums_prove_a_point <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_prove_a_point = sum(!is.na(`prove a point`)))
sums_gain_attention <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_gain_attention = sum(!is.na(`gain attention`)))
sums_entertain_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_entertain_others = sum(!is.na(`entertain others`)))
sums_provoke_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_provoke_others = sum(!is.na(`provoke others`)))
sums_surprise_shock <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_surprise_shock = sum(!is.na(`surprise or shock others`)))
sums_deceive_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_deceive_others = sum(!is.na(`deceive others`)))
sums_cause_chaos <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(sum_cause_chaos = sum(!is.na(`cause chaos`)))


# bind together
motive_sums <- sums_express_opinion %>%
  left_join(sums_inform_others, by = "subreddit") %>%
  left_join(sums_help_researchers, by = "subreddit") %>%
  left_join(sums_pursuade_others, by = "subreddit") %>%
  left_join(sums_bring_attention, by = "subreddit") %>%
  left_join(sums_connect_with_others, by = "subreddit") %>%
  left_join(sums_express_emotions, by = "subreddit") %>%
  left_join(sums_prove_a_point, by = "subreddit") %>%
  left_join(sums_gain_attention, by = "subreddit") %>%
  left_join(sums_entertain_others, by = "subreddit") %>%
  left_join(sums_provoke_others, by = "subreddit") %>%
  left_join(sums_surprise_shock, by = "subreddit") %>%
  left_join(sums_deceive_others, by = "subreddit") %>%
  left_join(sums_cause_chaos, by = "subreddit")


motive_sums <- motive_sums %>% filter(!is.na(subreddit))

subreddit_condition_table <- data.frame(subreddit = c("DiscussPolitics1", "DiscussPolitics6", "DiscussPolitics2", "DiscussPolitics5", "DiscussPolitics3", "DiscussPolitics4"),
                                        condition = c("control_1", "control_6", "moderation_2", "moderation_5", "incentives_3", "incentives_4"))

motive_sums <- left_join(motive_sums, subreddit_condition_table, by = "subreddit")

#rearrange rows of motive_sums to match order of subreddit_condition_table$subreddit
motive_sums <- motive_sums %>% arrange(condition)

motive_sums
```

```{r}
#make motive_means
means_express_opinion <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_express_opinion = mean(!is.na(`express my opinion`)))
means_inform_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_inform_others = mean(!is.na(`inform others`)))
means_help_researchers <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_help_researchers = mean(!is.na(`help researchers`)))
means_pursuade_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_pursuade_others = mean(!is.na(`pursuade others`)))
means_bring_attention <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_bring_attention = mean(!is.na(`bring attention to a topic`)))
means_connect_with_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_connect_with_others = mean(!is.na(`connect with others`)))
means_express_emotions <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_express_emotions = mean(!is.na(`express my emotions`)))
means_prove_a_point <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_prove_a_point = mean(!is.na(`prove a point`)))
means_gain_attention <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_gain_attention = mean(!is.na(`gain attention`)))
means_entertain_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_entertain_others = mean(!is.na(`entertain others`)))
means_provoke_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_provoke_others = mean(!is.na(`provoke others`)))
means_surprise_shock <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_surprise_shock = mean(!is.na(`surprise or shock others`)))
means_deceive_others <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_deceive_others = mean(!is.na(`deceive others`)))
means_cause_chaos <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(mean_cause_chaos = mean(!is.na(`cause chaos`)))


# bind together
motive_means <- means_express_opinion %>%
  left_join(means_inform_others, by = "subreddit") %>%
  left_join(means_help_researchers, by = "subreddit") %>%
  left_join(means_pursuade_others, by = "subreddit") %>%
  left_join(means_bring_attention, by = "subreddit") %>%
  left_join(means_connect_with_others, by = "subreddit") %>%
  left_join(means_express_emotions, by = "subreddit") %>%
  left_join(means_prove_a_point, by = "subreddit") %>%
  left_join(means_gain_attention, by = "subreddit") %>%
  left_join(means_entertain_others, by = "subreddit") %>%
  left_join(means_provoke_others, by = "subreddit") %>%
  left_join(means_surprise_shock, by = "subreddit") %>%
  left_join(means_deceive_others, by = "subreddit") %>%
  left_join(means_cause_chaos, by = "subreddit")



motive_means <- motive_means %>% filter(!is.na(subreddit))

subreddit_condition_table <- data.frame(subreddit = c("DiscussPolitics1", "DiscussPolitics6", "DiscussPolitics2", "DiscussPolitics5", "DiscussPolitics3", "DiscussPolitics4"),
                                        condition = c("control_1", "control_6", "moderation_2", "moderation_5", "incentives_3", "incentives_4"))

motive_means <- left_join(motive_means, subreddit_condition_table, by = "subreddit")

#rearrange rows of motive_means to match order of subreddit_condition_table$subreddit
motive_means <- motive_means %>% arrange(condition)

motive_means

```

```{r, fig.width=10, fig.height = 6}
# barplot of means by subreddits



#barplot of mean_express_opinion by subreddit
barplot(motive_means$mean_express_opinion, names.arg = motive_means$condition, col = "grey", main = "Mean Express Opinion by Subreddit", xlab = "Subreddit", ylab = "Mean Express Opinion")

#barplot of mean_inform_others by subreddit
barplot(motive_means$mean_inform_others, names.arg = motive_means$condition, col = "grey", main = "Mean Inform Others by Subreddit", xlab = "Subreddit", ylab = "Mean Inform Others")

#barplot of mean_help_researchers by subreddit
barplot(motive_means$mean_help_researchers, names.arg = motive_means$condition, col = "grey", main = "Mean Help Researchers by Subreddit", xlab = "Subreddit", ylab = "Mean Help Researchers")

#barplot of mean_pursuade_others by subreddit
barplot(motive_means$mean_pursuade_others, names.arg = motive_means$condition, col = "grey", main = "Mean Pursuade Others by Subreddit", xlab = "Subreddit", ylab = "Mean Pursuade Others")

#barplot of mean_bring_attention by subreddit
barplot(motive_means$mean_bring_attention, names.arg = motive_means$condition, col = "grey", main = "Mean Bring Attention by Subreddit", xlab = "Subreddit", ylab = "Mean Bring Attention")

#barplot of mean_connect_with_others by subreddit
barplot(motive_means$mean_connect_with_others, names.arg = motive_means$condition, col = "grey", main = "Mean Connect With Others by Subreddit", xlab = "Subreddit", ylab = "Mean Connect With Others")

#barplot of mean_express_emotions by subreddit
barplot(motive_means$mean_express_emotions, names.arg = motive_means$condition, col = "grey", main = "Mean Express Emotions by Subreddit", xlab = "Subreddit", ylab = "Mean Express Emotions")

#barplot of mean_prove_a_point by subreddit
barplot(motive_means$mean_prove_a_point, names.arg = motive_means$condition, col = "grey", main = "Mean Prove A Point by Subreddit", xlab = "Subreddit", ylab = "Mean Prove A Point")

#barplot of mean_gain_attention by subreddit
barplot(motive_means$mean_gain_attention, names.arg = motive_means$condition, col = "grey", main = "Mean Gain Attention by Subreddit", xlab = "Subreddit", ylab = "Mean Gain Attention")

#barplot of mean_entertain_others by subreddit
barplot(motive_means$mean_entertain_others, names.arg = motive_means$condition, col = "grey", main = "Mean Entertain Others by Subreddit", xlab = "Subreddit", ylab = "Mean Entertain Others")

#barplot of mean_provoke_others by subreddit
barplot(motive_means$mean_provoke_others, names.arg = motive_means$condition, col = "grey", main = "Mean Provoke Others by Subreddit", xlab = "Subreddit", ylab = "Mean Provoke Others")

#barplot of mean_surprise_shock by subreddit
barplot(motive_means$mean_surprise_shock, names.arg = motive_means$condition, col = "grey", main = "Mean Surprise Shock by Subreddit", xlab = "Subreddit", ylab = "Mean Surprise Shock")

#barplot of mean_deceive_others by subreddit
barplot(motive_means$mean_deceive_others, names.arg = motive_means$condition, col = "grey", main = "Mean Deceive Others by Subreddit", xlab = "Subreddit", ylab = "Mean Deceive Others")

#barplot of mean_cause_chaos by subreddit
barplot(motive_means$mean_cause_chaos, names.arg = motive_means$condition, col = "grey", main = "Mean Cause Chaos by Subreddit", xlab = "Subreddit", ylab = "Mean Cause Chaos")

```



## WS: Plot Other Participant-Traits-Weighted-By-CommCount

```{r}
par(cex=.8)
these_means <- internal_comments_augmented %>% group_by(subreddit) %>% dplyr::summarize(this_mean = mean(gender==1, na.rm = T)) %>% drop_na

these_means <- left_join(subreddit_condition_table, these_means, by = c("subreddit" = "subreddit")) %>% arrange(condition)

barplot(these_means$this_mean, names.arg = these_means$condition, col = "grey", main = "Prop. Comments From Male Users", xlab = "Subreddit", ylab = "Proportion of All Comments", ylim = c(0,.8))
abline(h=.5)
```




```{r}
these_means <- internal_comments_augmented %>% group_by(condition) %>% dplyr::summarize(this_mean = mean(gender==1, na.rm = T)) %>% drop_na

barplot(these_means$this_mean, names.arg = these_means$condition, col = "grey", main = "", xlab = "Subreddit", ylab = "Prop. Posts From _____ Users")

```


```{r}


```


```{r}


```






# WS: Inspect incentivized posting-per-day (more than 1 has particular implications here)

```{r}
internal_comments_augmented

```

```{r}


```

```{r}


```

```{r}


```

```{r}


```

```{r}


```

```{r}


```

```{r}

#names(internal_comments_augmented) <- gsub(" ", "_", names(internal_comments_augmented))
```


# WS: commenting by motivation*condition


```{r}
#first replace all spaces with underscores in the column names
names(ps) <- gsub(" ", "_", names(ps))
names(s) <- gsub(" ", "_", names(s))


```


```{r}
#ps$express_my_opinion %>% unique

motive_barrier_colnames <- c("inform_others","entertain_others",
"express_my_opinion","provoke_others","express_my_emotions",
"connect_with_others","deceive_others","gain_attention",
"prove_a_point","cause_chaos","bring_attention_to_a_topic",
"pursuade_others","surprise_or_shock_others","help_researchers",
"no_barriers","personally_triggered","could_not_add_anything",
"intimidated_by_sophistication","afraid_of_backlash")

# get unique values of all rows of selected columns
unique(ps[motive_barrier_colnames])

#replace NAs with 0s in the selected columns
ps[motive_barrier_colnames] <- lapply(ps[motive_barrier_colnames], function(x) ifelse(is.na(x), 0, x))
```


```{r}
#check whether the same ParticipantID has the same motive nonzero in multiple rows
ps %>% group_by(ParticipantID) %>% dplyr::summarize(sum_inform_others = sum(inform_others), sum_entertain_others = sum(entertain_others), sum_express_my_opinion = sum(express_my_opinion), sum_provoke_others = sum(provoke_others), sum_express_my_emotions = sum(express_my_emotions), sum_connect_with_others = sum(connect_with_others), sum_deceive_others = sum(deceive_others), sum_gain_attention = sum(gain_attention), sum_prove_a_point = sum(prove_a_point), sum_cause_chaos = sum(cause_chaos), sum_bring_attention_to_a_topic = sum(bring_attention_to_a_topic), sum_pursuade_others = sum(pursuade_others), sum_surprise_or_shock_others = sum(surprise_or_shock_others), sum_help_researchers = sum(help_researchers), sum_no_barriers = sum(no_barriers), sum_personally_triggered = sum(personally_triggered), sum_could_not_add_anything = sum(could_not_add_anything), sum_intimidated_by_sophistication = sum(intimidated_by_sophistication), sum_afraid_of_backlash = sum(afraid_of_backlash))

#check number of responses from each ParticipantID
ps %>% group_by(ParticipantID) %>% dplyr::summarize(n = n())

ps
```



```{r}
# pad out the ps dataframe to have a row for each ParticipantID-survey_week combination
# first, get all unique ParticipantIDs
#unique_participant_ids <- ps$ParticipantID %>% unique()
ps_padded <- ps %>%
  complete(ParticipantID, survey_week) 

ps_padded
```


```{r}
# #sum motives across waves
# ps_padded_summotives <- ps_padded %>% group_by(ParticipantID) %>% dplyr::summarize(sum_inform_others = sum(inform_others), last_week_present =, sum_entertain_others = sum(entertain_others), sum_express_my_opinion = sum(express_my_opinion), sum_provoke_others = sum(provoke_others), sum_express_my_emotions = sum(express_my_emotions), sum_connect_with_others = sum(connect_with_others), sum_deceive_others = sum(deceive_others), sum_gain_attention = sum(gain_attention), sum_prove_a_point = sum(prove_a_point), sum_cause_chaos = sum(cause_chaos), sum_bring_attention_to_a_topic = sum(bring_attention_to_a_topic), sum_pursuade_others = sum(pursuade_others), sum_surprise_or_shock_others = sum(surprise_or_shock_others), sum_help_researchers = sum(help_researchers), sum_no_barriers = sum(no_barriers), sum_personally_triggered = sum(personally_triggered), sum_could_not_add_anything = sum(could_not_add_anything), sum_intimidated_by_sophistication = sum(intimidated_by_sophistication), sum_afraid_of_backlash = sum(afraid_of_backlash))
# ps_padded_summotives

#mean motives across waves, dropping NAs
W4_completers <- ps_padded %>% filter(survey_week == 4) %>% filter(!is.na(StartDate)) %>% pull(ParticipantID) %>% unique()
#W4_completers

ps_padded_summarystats <- ps_padded %>% ungroup() %>% group_by(ParticipantID) %>% dplyr::summarize(non_na_row_count = sum(!is.na(StartDate))) %>% mutate(w4_complete = (ParticipantID %in% W4_completers))



ps_padded_meanmotives <- ps_padded %>% ungroup() %>% group_by(ParticipantID) %>% dplyr::summarize(mean_inform_others = mean(inform_others, na.rm = TRUE), mean_entertain_others = mean(entertain_others, na.rm = TRUE), mean_express_my_opinion = mean(express_my_opinion, na.rm = TRUE), mean_provoke_others = mean(provoke_others, na.rm = TRUE), mean_express_my_emotions = mean(express_my_emotions, na.rm = TRUE), mean_connect_with_others = mean(connect_with_others, na.rm = TRUE), mean_deceive_others = mean(deceive_others, na.rm = TRUE), mean_gain_attention = mean(gain_attention, na.rm = TRUE), mean_prove_a_point = mean(prove_a_point, na.rm = TRUE), mean_cause_chaos = mean(cause_chaos, na.rm = TRUE), mean_bring_attention_to_a_topic = mean(bring_attention_to_a_topic, na.rm = TRUE), mean_pursuade_others = mean(pursuade_others, na.rm = TRUE), mean_surprise_or_shock_others = mean(surprise_or_shock_others, na.rm = TRUE), mean_help_researchers = mean(help_researchers, na.rm = TRUE), mean_no_barriers = mean(no_barriers, na.rm = TRUE), mean_personally_triggered = mean(personally_triggered, na.rm = TRUE), mean_could_not_add_anything = mean(could_not_add_anything, na.rm = TRUE), mean_intimidated_by_sophistication = mean(intimidated_by_sophistication, na.rm = TRUE), mean_afraid_of_backlash = mean(afraid_of_backlash, na.rm = TRUE))
ps_padded_meanmotives

ps_padded_meanmotives <- left_join(ps_padded_meanmotives, ps_padded_summarystats, by = "ParticipantID")

ps_padded_meanmotives %>% filter(w4_complete)


ps_padded_meanmotives %>% pull(non_na_row_count) %>% hist
```


```{r}
ps_padded_meanmotives

s_aug <- left_join(ps_padded_meanmotives, s, by = "ParticipantID") %>% 
  mutate(subreddit = as.factor(subreddit))
s_aug
```


```{r}
test_mod <- lm(mean_daily_comments_instudy ~ mean_express_my_opinion + mean_express_my_emotions, data = s_aug)

test_mod %>% summary

# a model with all motives as predictors
lm_all_motives <- lm(mean_daily_comments_instudy ~ mean_inform_others + mean_entertain_others + mean_express_my_opinion + mean_provoke_others + mean_express_my_emotions + mean_connect_with_others + mean_deceive_others + mean_gain_attention + mean_prove_a_point + mean_cause_chaos + mean_bring_attention_to_a_topic + mean_pursuade_others + mean_surprise_or_shock_others + mean_help_researchers + mean_no_barriers + mean_personally_triggered + mean_could_not_add_anything + mean_intimidated_by_sophistication + mean_afraid_of_backlash, data = s_aug)

lm_all_motives %>% summary

#plot variance of each motive
for(motive in paste0("mean_", motive_barrier_colnames)){
  print(motive)
  hist(s_aug[[motive]])
}

#rank motives by variance
motive_variances <- sapply(paste0("mean_", motive_barrier_colnames), function(motive) var(s_aug[[motive]]))
sort(motive_variances, decreasing = TRUE)

s_aug[[motive]]


lm_var_motives <- lm(mean_daily_comments_instudy ~ mean_inform_others + mean_help_researchers + mean_pursuade_others + mean_express_my_opinion + mean_bring_attention_to_a_topic + mean_connect_with_others + mean_express_my_emotions +  mean_could_not_add_anything + mean_entertain_others + mean_prove_a_point, data = s_aug)

lm_var_motives <- lm(mean_daily_comments_instudy ~ gender + mean_inform_others + mean_help_researchers + mean_pursuade_others + mean_express_my_opinion, data = s_aug)

lm_var_motives %>% summary

s_aug$gender

```


```{r}
library(glmnet)
# implement a lasso regression
x <- model.matrix(mean_daily_comments_instudy ~ mean_inform_others + mean_help_researchers + mean_pursuade_others + mean_express_my_opinion + mean_bring_attention_to_a_topic + mean_connect_with_others + mean_express_my_emotions +  mean_could_not_add_anything + mean_entertain_others + mean_prove_a_point, data = s_aug)[,-1]

y <- s_aug$mean_daily_comments_instudy

#ensure no NAs
x <- x[complete.cases(x),]
y <- y[complete.cases(y)]

cvfit <- cv.glmnet(x, y, alpha = 1, trace.it = T, nfolds = 5)

cvfit$lambda.min

#inspect estimates
coef(cvfit, s = "lambda.min")

```


```{r}
lm_int_test <- lm(mean_daily_comments_instudy ~ mean_pursuade_others*condition, data = s_aug)
lm_int_test %>% summary

#implement lme4 version with random intercepts at the subreddit level
library(lme4)
lmer_int_test <- lmer(mean_daily_comments_instudy ~ mean_pursuade_others*condition + (1 | subreddit), data = s_aug)

lmer_int_test

#inspect
summary(lmer_int_test)
```


```{r}
library(psych)

#reduce dimensionality of motives with PCA
motive_pca <- psych::pca(s_aug %>% select("mean_inform_others", "mean_entertain_others", "mean_express_my_opinion", "mean_provoke_others", "mean_express_my_emotions", "mean_connect_with_others", "mean_deceive_others", "mean_gain_attention", "mean_prove_a_point", "mean_cause_chaos", "mean_bring_attention_to_a_topic", "mean_pursuade_others", "mean_surprise_or_shock_others", "mean_help_researchers", "mean_no_barriers", "mean_personally_triggered", "mean_could_not_add_anything", "mean_intimidated_by_sophistication", "mean_afraid_of_backlash"), nfactors = 4)

motive_pca

#extract scores and join them to s_aug
s_aug <- cbind(s_aug, motive_pca$scores)

s_aug

```


```{r}
lm_int_test <- lm(mean_daily_comments_instudy ~ RC1*condition, data = s_aug)
lm_int_test %>% summary

```






```{r}


```


```{r}


```



```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


# WS: Analyze Ideological Extremity, Actual Agreement with other Posters

```{r}


```

```{r}


```

# Analyze Education as predictor of loquaciousness

```{r}
lm(mean_daily_comments_instudy ~ education, data = s_aug) %>% summary

```



# Analyze First-Mover Effect on a Daily Basis

Idea: daily toxicity is a function of the toxicity of the first post(s) of the day

```{r}
#discussion_data
internal_comments

```


```{r}
internal_comments_ws <- discussion_data %>% mutate(source = "internal")%>%
  filter(created_comment > as_datetime("2024-06-10") & created_comment < as_datetime("2024-07-06"))

internal_comments_ws

# ParticipantID comment_id parent_id

```


```{r}
internal_comments_ws %>% pull(parent_id) %>% unique()

```


```{r}


```


```{r}


```


```{r}


```


# fraction of comments they account for on their subreddit

```{r}

all_data

internal_comments_augmented %>% filter(subreddit=="DiscussPolitics1") %>% group_by(ParticipantID) %>% dplyr::summarize(n = n(), frac = n()/nrow(.))

```

```{r}


```


# WS: Investigate Scores as an Incentive to Keep Participating

```{r}
internal_comments_augmented

```


```{r}
plot(internal_comments_augmented$score, internal_comments_augmented$comment_toxicity)

```


```{r}
discussion_data

```


```{r}
#discussion_data$created_post %>% unique %>% hist(breaks = "hour", freq = T)

discussion_data$created_comment %>% unique %>% hist(breaks = "hour", freq = T) #this is the one to use
```


```{r}
discussion_data$score_comment %>% hist




```


```{r}
#arrange by day

daily_discussion_data <- discussion_data %>% arrange(created_comment) %>% mutate(day = as.Date(created_comment)) %>% group_by(ParticipantID, day) %>% dplyr::summarize(n_comments = n(), mean_score = mean(score_comment), mean_toxicity = mean(comment_toxicity, na.rm=T), sum_score = sum(score_comment, na.rm=T))

daily_discussion_data

```



## Implement lagged model

```{r}

daily_discussion_data_complete <- daily_discussion_data %>% ungroup %>% complete(ParticipantID, day)

daily_discussion_data_complete$n_comments[which(is.na(daily_discussion_data_complete$n_comments))] <- 0

```


```{r}
data <- daily_discussion_data_complete

#add progress bar
pb <- txtProgressBar(min = 0, max = nrow(data), style = 3)

for (i in 1:nrow(data)) {
  setTxtProgressBar(pb, i)
  if (data$day[i] <= (data %>% filter(ParticipantID == data$ParticipantID[i]) %>% filter(n_comments!=0) %>% pull(day) %>% min)){
    data$mean_score_lag[i] <- NA
    data$sum_score_lag[i] <- NA
  } else {
    lags <- data %>% filter(ParticipantID == data$ParticipantID[i] & day < data$day[i]) %>% dplyr::summarize(mean_score = mean(mean_score, na.rm = T), sum_score = sum(sum_score, na.rm = T))
    data$mean_score_lag[i] <- lags %>% pull(mean_score)
    data$sum_score_lag[i] <- lags %>% pull(sum_score)
  }
}

data %>% select(-mean_score)

#data %>% select(-mean_score) %>% tail
```



```{r}
#star
library(lme4)
# Fit the Poisson GLMM
model <- glmer(n_comments ~ mean_score_lag + (1 | ParticipantID), 
               data = data, 
               family = poisson(link = "log"),
               na.action = na.exclude)

# Summarize the model
summary(model)


```

```{r}
#try predicting toxicity
library(lme4)
# Fit the Poisson GLMM
model <- glmer(mean_toxicity ~ mean_score_lag + (1 | ParticipantID), 
               data = data %>% filter(!is.na(mean_toxicity)), 
               family = poisson(link = "log"),
               na.action = na.exclude)

# Summarize the model
summary(model)


```


```{r}
library(lme4)
# Fit the Poisson GLMM
model <- glmer(n_comments ~ sum_score_lag + (1 | ParticipantID), 
               data = data, 
               family = poisson(link = "log"),
               na.action = na.exclude)

# Summarize the model
summary(model)


```



```{r}
data_aug <- left_join(data, s_aug, by = "ParticipantID") %>% mutate(condition = as.factor(condition))
data_aug
```


```{r}
#star
library(lme4)
# Fit the Poisson GLMM
model <- glmer(n_comments ~ mean_score_lag + polinterest + (1 | ParticipantID) + (1 | subreddit), 
               data = data_aug, 
               family = poisson(link = "log"),
               na.action = na.exclude)

# Summarize the model
summary(model)

```



```{r}
#star
library(lme4)
# Fit the Poisson GLMM
model <- glmer(n_comments ~ mean_score_lag*condition + polinterest + (1 | ParticipantID) + (1 | subreddit), 
               data = data_aug, 
               family = poisson(link = "log"),
               na.action = na.exclude)

# Summarize the model
summary(model)

```

```{r}
#star
library(lme4)
# Fit the Poisson GLMM
model <- glmer(n_comments ~ mean_score_lag*incentives + polinterest + (1 | ParticipantID) + (1 | subreddit), 
               data = data_aug %>% mutate(incentives = (condition=="incentives")), 
               family = poisson(link = "log"),
               na.action = na.exclude)

# Summarize the model
summary(model)

```


## WS: Investigate score and probability of dropping out of the panel

```{r}
data_aug

```


```{r}


```


```{r}


```





